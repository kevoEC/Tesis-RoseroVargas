import{f as te,u as ie,c as ce,r as i,t as l,j as e,G as le,h as x,B as c,F as I,w as U,E as q,L as de}from"./index-ABbIRX4x.js";import{T as P}from"./TablaCustom2-DS7_i3Ng.js";import{D as me,a as ue,b as xe,c as ge,d as he}from"./jspdf.plugin.autotable-CZR7NrjE.js";import{A as fe}from"./AdjuntoForm-DZV0TiXW.js";import{g as be,a as ye,b as pe,c as je,d as Ne,e as Ae}from"./AdendumService-DLpFzeby.js";import{a as _}from"./ProyeccionService-PEcHVMkt.js";const we={1:{txt:"Creado",color:"bg-blue-100 text-blue-700"},2:{txt:"Conciliación",color:"bg-yellow-100 text-yellow-700"},3:{txt:"Finalizado",color:"bg-green-100 text-green-700"},4:{txt:"Proyectado",color:"bg-purple-100 text-purple-700"}};function H({estado:a}){const d=we[a]||{txt:"Desconocido",color:"bg-gray-200 text-gray-500"};return e.jsxs("span",{className:`inline-flex items-center gap-1 px-3 py-1 text-xs font-bold rounded-full ${d.color}`,children:[d.txt,[3,4].includes(a)&&e.jsx(x,{className:"inline w-4 h-4 ml-1"})]})}function ve(){const{idAdendum:a}=te(),d=ie(),{user:p,roles:$}=ce(),g=p==null?void 0:p.id,[r,S]=i.useState(null),[J,v]=i.useState(!0),[z,j]=i.useState([]),[F,N]=i.useState([]),[K,L]=i.useState(!1),[m,A]=i.useState([]),[Q,u]=i.useState(!1),[W,w]=i.useState(null),[O,h]=i.useState(!1),[X,C]=i.useState(!1),[D,G]=i.useState(!1),[Z,E]=i.useState(!1),[f,B]=i.useState(!1),[T,V]=i.useState(!1);i.useEffect(()=>{b()},[a]);const b=async()=>{var s,n;v(!0);try{const o=await be(a);if(!(o!=null&&o.success))throw new Error("No se pudo obtener Adendum");if(S(o.adendum),(s=o.adendum)!=null&&s.idProyeccionOriginal){const t=await _(o.adendum.idProyeccionOriginal);j(Array.isArray(t==null?void 0:t.cronograma)?t.cronograma:[])}else j([]);if((n=o.adendum)!=null&&n.idProyeccionIncremento){const t=await _(o.adendum.idProyeccionIncremento);N(Array.isArray(t==null?void 0:t.cronograma)?t.cronograma:[])}else N([]);await y(o.adendum.idAdendum)}catch(o){l.error("Error al cargar Adendum: "+(o.message||o)),S(null),j([]),N([]),A([])}finally{v(!1)}},y=async s=>{L(!0);try{const n=await ye(s);if(!n.success)throw new Error("Error al obtener documentos");A(Array.isArray(n.documentos)?n.documentos:[])}catch(n){l.error("Error al cargar documentos: "+(n.message||n)),A([])}finally{L(!1)}},M=s=>{if(!s)return!1;const n="Conciliación comprobante de abono (Adendum)",o=["Administrador","Analista financiero"];return!!(s.documentoNombre===n&&$.some(t=>o.includes(t))||(r==null?void 0:r.estado)!==3)},R=(r==null?void 0:r.estado)===4,ee=m.some(s=>s.archivoBase64!==null)&&(r==null?void 0:r.estado)===2,re=async()=>{if(R){V(!0);try{const s=await pe(r.idAdendum,g);if(!s.success)throw new Error(s.message||"Error al generar documentos");l.success("Documentos generados correctamente"),await y(r.idAdendum),await b()}catch(s){l.error("Error al generar documentos: "+(s.message||s))}finally{V(!1)}}},ae=async()=>{E(!1),B(!0);try{const s=await je(r.idAdendum,g);if(!s.success)throw new Error(s.message||"Error al continuar flujo");l.success("Adendum actualizado y flujo continuado correctamente"),await b(),await y(r.idAdendum)}catch(s){l.error("Error al confirmar incremento: "+(s.message||s))}finally{B(!1)}},se=r&&!r.idProyeccionIncremento&&r.estado!==3,oe=async()=>{var s,n;G(!0);try{const o=await Ne({idProyeccionOriginal:r.idProyeccionOriginal,periodoIncremento:r.periodoIncremento,montoIncremento:r.montoIncremento,idUsuario:g});if(!o.success)throw new Error(o.message||"No se pudo crear incremento");if(!(await Ae({idAdendum:r.idAdendum,idProyeccionIncremento:o.proyeccion.idProyeccion,idCronogramaProyeccionIncremento:((n=(s=o.cronograma)==null?void 0:s[0])==null?void 0:n.idCronogramaProyeccion)??o.idProyeccion,idUsuarioModificacion:g})).success)throw new Error("No se pudo actualizar Adendum con el incremento");l.success("¡Incremento realizado y Adendum actualizado!"),C(!1),await b()}catch(o){l.error("Error al realizar incremento: "+(o.message||o))}finally{G(!1)}},ne=[{key:"idDocumento",label:"ID"},{key:"idTipoDocumento",label:"ID Tipo"},{key:"documentoNombre",label:"Nombre"},{key:"acciones",label:"Acciones",render:(s,n)=>{const o=r.estado===3,t=M(n);return o?e.jsx(c,{type:"button",size:"icon",variant:"ghost",className:"text-primary hover:bg-violet-100",onClick:()=>{w(n.idDocumento),h(!0),u(!0)},title:"Ver documento",children:e.jsx(q,{size:18})}):e.jsx(c,{type:"button",size:"icon",variant:"ghost",className:"text-primary hover:bg-violet-100",onClick:()=>{w(n.idDocumento),h(!t),u(!0)},title:t?"Editar documento":"Ver documento",disabled:r.estado===3,children:e.jsx(q,{size:18})})}}];return J||!r?e.jsx(le,{visible:!0,message:"Cargando Adendum..."}):e.jsxs("div",{className:"relative",children:[[3,4].includes(r.estado)&&e.jsxs("div",{className:"w-full flex items-center px-6 py-2 bg-gray-50 border-b border-gray-300 shadow-sm mb-2 z-50",style:{position:"sticky",top:0},children:[e.jsx(x,{className:"text-gray-700 w-5 h-5 mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700 text-sm",children:r.estado===3?"Este Adendum está cerrado y es de solo lectura.":"Este Adendum está proyectado y bloqueado."})]}),e.jsxs("div",{className:"p-6 md:p-10 max-w-6xl mx-auto bg-white",children:[e.jsx("div",{className:"flex flex-wrap items-center gap-2 mb-4 justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(c,{variant:"outline",onClick:()=>d(-1),className:"px-4 py-1",children:"Regresar"}),e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-gray-900",children:r.nombreAdendum}),e.jsx(H,{estado:r.estado})]})}),e.jsxs("div",{className:"flex flex-wrap text-xs text-gray-700 mb-6 border-b pb-2 gap-8",children:[e.jsxs("span",{children:[e.jsx("b",{children:"Creado:"})," ",r.fechaCreacion?new Date(r.fechaCreacion).toLocaleString("es-EC"):"-"]}),e.jsxs("span",{children:[e.jsx("b",{children:"Owner:"})," ",r.idUsuarioPropietario||"-"]})]}),e.jsxs("section",{className:"border rounded-xl p-6 shadow-sm mb-6 flex flex-col gap-3",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 items-center",children:[e.jsx(k,{label:"Monto de Incremento",children:e.jsx("input",{type:"number",value:r.montoIncremento,disabled:!0,className:"bg-gray-100 text-gray-700 font-medium"})}),e.jsx(k,{label:"Periodo de Incremento",children:e.jsx("input",{type:"number",value:r.periodoIncremento,disabled:!0,className:"bg-gray-100 text-gray-700 font-medium"})}),e.jsx(k,{label:"Estado",children:e.jsx(H,{estado:r.estado})})]}),e.jsxs("div",{className:"mt-4 flex gap-4 justify-end",children:[R&&e.jsxs(c,{className:"bg-blue-600 hover:bg-blue-700 text-white px-6",onClick:re,disabled:T||m.length>0||r.estado===3,title:m.length>0?"Ya hay documentos generados":r.estado===3?"Adendum cerrado. No puede generar documentos":"",children:[T?e.jsx("span",{className:"animate-spin mr-2",children:"⏳"}):e.jsx(I,{className:"mr-2"}),"Generar Documentos"]}),ee&&e.jsxs(c,{className:"bg-green-600 hover:bg-green-700 text-white px-6",onClick:()=>E(!0),disabled:f||r.estado===3,title:r.estado===3?"Adendum cerrado. No puede confirmar incremento":"",children:[f?e.jsx("span",{className:"animate-spin mr-2",children:"⏳"}):e.jsx(U,{className:"mr-2"}),"Confirmar Incremento"]})]})]}),e.jsxs("section",{className:"border rounded-xl p-6 shadow-sm mb-6",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-800 mb-3",children:"Cronograma proyección inicial"}),e.jsx(P,{columns:Y(),data:Array.isArray(z)?z:[],mostrarEditar:!1,mostrarAgregarNuevo:!1,mostrarEliminar:!1})]}),e.jsxs("section",{className:"border rounded-xl p-6 shadow-sm mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-800",children:"Cronograma proyección de incremento"}),!r.idProyeccionIncremento&&e.jsx(x,{className:"w-5 h-5 text-gray-400",title:"Bloqueado hasta generar incremento"})]}),r.idProyeccionIncremento?e.jsx(P,{columns:Y(),data:Array.isArray(F)?F:[],mostrarEditar:!1,mostrarAgregarNuevo:!1,mostrarEliminar:!1}):e.jsxs("div",{className:"bg-gray-100 rounded-xl py-8 px-4 text-center text-gray-600 flex flex-col items-center gap-2",children:[e.jsx(x,{className:"w-8 h-8 mb-1 text-gray-400"}),e.jsx("span",{children:'Proyección de incremento aún no generada. Para realizar el incremento pulsa el botón "Generar incremento".'}),se&&e.jsxs(c,{className:"mt-3 bg-violet-600 hover:bg-violet-700 text-white px-8",onClick:()=>C(!0),disabled:D||r.estado===3,title:r.estado===3?"Adendum cerrado. No puede generar incremento":"",children:[e.jsx(I,{className:"mr-2"})," Generar incremento"]})]})]}),e.jsxs("section",{className:"border rounded-xl p-6 shadow-sm mt-0 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Documentos Adjuntos"}),e.jsx(P,{columns:ne,data:Array.isArray(m)?m:[],mostrarEditar:!1,mostrarAgregarNuevo:!1,mostrarEliminar:!1,loading:K,onEditarClick:s=>{w(s.idDocumento),r.estado===3?h(!0):h(!M(s)),u(!0)}})]}),Z&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex justify-center items-center z-50",children:e.jsxs("div",{className:"bg-white p-8 rounded-xl shadow-lg max-w-sm w-full border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(x,{className:"text-gray-700 w-5 h-5"}),e.jsx("span",{className:"font-bold text-lg text-gray-800",children:"¿Estás seguro de finalizar el Adendum?"})]}),e.jsxs("p",{className:"text-gray-700 mb-4",children:["Esta acción modificará la inversión de forma permanente y no podrá deshacerse.",e.jsx("br",{}),e.jsx("b",{children:"¿Deseas continuar?"})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-5",children:[e.jsx(c,{variant:"outline",onClick:()=>E(!1),children:"Cancelar"}),e.jsxs(c,{className:"bg-green-600 text-white",onClick:ae,disabled:f,children:[f?e.jsx("span",{className:"animate-spin mr-2",children:"⏳"}):null,"Sí, finalizar"]})]})]})}),e.jsx(me,{open:Q,onOpenChange:u,children:e.jsxs(ue,{children:[e.jsxs(xe,{children:[e.jsx(ge,{children:"Adjunto"}),e.jsx(he,{children:O?"Visualización de archivo adjunto":"Editar archivo"})]}),e.jsx(fe,{documentoId:W,readOnly:O,onClose:()=>{u(!1),r!=null&&r.idAdendum&&y(r.idAdendum)}})]})}),X&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex justify-center items-center z-50",children:e.jsxs("div",{className:"bg-white p-8 rounded-xl shadow-lg max-w-sm w-full border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(I,{className:"w-7 h-7 text-violet-600"}),e.jsx("span",{className:"font-bold text-lg text-gray-800",children:"¿Estás seguro de generar el incremento?"})]}),e.jsxs("p",{className:"text-gray-700 mb-4",children:["Una vez generado el incremento no podrás editar el monto ni el periodo.",e.jsx("br",{}),e.jsx("b",{children:"¿Deseas continuar?"})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-5",children:[e.jsx(c,{variant:"outline",onClick:()=>C(!1),children:"Cancelar"}),e.jsxs(c,{className:"bg-violet-600 text-white",onClick:oe,disabled:D,children:[D?e.jsx("span",{className:"animate-spin mr-2",children:"⏳"}):e.jsx(U,{className:"w-4 h-4 mr-1"}),"Sí, generar incremento"]})]})]})})]})]})}function Y(){return[{key:"periodo",label:"Periodo"},{key:"fechaInicial",label:"Fecha Inicial",render:a=>a?new Date(a).toLocaleDateString():"-"},{key:"fechaVencimiento",label:"Fecha Vencimiento",render:a=>a?new Date(a).toLocaleDateString():"-"},{key:"capital",label:"Capital",render:a=>(a==null?void 0:a.toLocaleString("es-EC",{minimumFractionDigits:2}))??"0.00"},{key:"aporteAdicional",label:"Aporte Adic.",render:a=>(a==null?void 0:a.toLocaleString("es-EC",{minimumFractionDigits:2}))??"0.00"},{key:"tasa",label:"Tasa (%)",render:a=>(a==null?void 0:a.toFixed(4))??"-"},{key:"rentabilidad",label:"Rentab.",render:a=>(a==null?void 0:a.toLocaleString("es-EC",{minimumFractionDigits:2}))??"0.00"},{key:"rentaPeriodo",label:"Renta Periodo",render:a=>(a==null?void 0:a.toLocaleString("es-EC",{minimumFractionDigits:2}))??"0.00"},{key:"costoOperativo",label:"Costo Oper.",render:a=>(a==null?void 0:a.toLocaleString("es-EC",{minimumFractionDigits:2}))??"0.00"},{key:"montoPagar",label:"Monto Pagar",render:a=>(a==null?void 0:a.toLocaleString("es-EC",{minimumFractionDigits:2}))??"0.00"}]}function k({label:a,children:d}){return e.jsxs("div",{className:"space-y-1.5 relative",children:[e.jsx(de,{className:"font-medium text-gray-700 text-sm",children:a}),d]})}export{ve as default};
