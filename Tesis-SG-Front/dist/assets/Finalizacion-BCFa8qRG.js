import{v as ta,r as c,t as h,j as e,l as ca,aN as Me,C as Y,a as _,B as Z,L as $,I as q,A as U,f as we,G as se,aO as la,c as Xe,S as da}from"./index-ABbIRX4x.js";import{S as ue}from"./switch-BQg2MTGH.js";import{S as O,a as G,b as L,c as V,d as k}from"./select-C75wXMdb.js";import{b as ce,v as ua,a as ma,u as re,f as fa}from"./SolicitudService-BRPNL4PC.js";import{g as ga}from"./TipoSolicitudService-CPF5HMHv.js";import{g as ha}from"./TipoClienteService-BAK64bBK.js";import{g as Ze}from"./TipoIdentificacionService-BJmrDHaB.js";import{m as te}from"./Adjuntos-DaBg_yYZ.js";import{b as ba}from"./ProyeccionService-PEcHVMkt.js";import{T as Be,g as ea}from"./TablaCustom2-DS7_i3Ng.js";import{D as ze,a as Oe,e as Ge,b as aa,c as ia}from"./jspdf.plugin.autotable-CZR7NrjE.js";import xa from"./ProyeccionNueva-DfKzqoJI.js";import{A as je,a as ve,b as ye,c as Ce,d as Ne,e as Se,f as Ue,g as pa}from"./alert-dialog-BbB2nhGe.js";import{g as ja,a as va}from"./BancoService-CbhJQYfY.js";import{f as ya}from"./TareaService-8EzhbblL.js";const Ca=a=>({idTipoSolicitud:a.idTipoSolicitud??a.tipoSolicitud??null,idTipoCliente:a.idTipoCliente??a.tipoCliente??null,idTipoDocumento:a.idTipoDocumento??a.tipoDocumento??null,numeroDocumento:a.numeroDocumento||"",nombres:a.nombres||"",apellidoPaterno:a.apellidoPaterno||"",apellidoMaterno:a.apellidoMaterno||"",validar:a.validar||!1,equifax:a.equifax||"",obsEquifax:a.obsEquifax||"",listasControl:a.listasControl||"",obsListasControl:a.obsListasControl||"",continuar:typeof a.continuar=="number"?a.continuar:1});function hi({id:a,bloquearEdicion:i=!1}){const{notify:u,setSolicitudHabilitada:b}=ta(),[S,s]=c.useState([]),[E,l]=c.useState([]),[P,v]=c.useState([]),[I,y]=c.useState(null),[g,T]=c.useState(!1),[x,D]=c.useState(!1),[j,n]=c.useState(!1),[t,F]=c.useState({idTipoSolicitud:null,idTipoCliente:null,idTipoDocumento:null,numeroDocumento:"",nombres:"",apellidoPaterno:"",apellidoMaterno:"",validar:!1,equifax:"",obsEquifax:"",listasControl:"",obsListasControl:"",continuar:1}),m=[{id:1,label:"Continuar con la solicitud"},{id:0,label:"Rechazar solicitud"}];c.useEffect(()=>{(async()=>{try{const[r,N,C]=await Promise.all([ga(),ha(),Ze()]);s(r),l(N),v(C)}catch(r){h.error("Error al cargar catálogos: "+r.message)}})()},[]),c.useEffect(()=>{(async()=>{try{const N=(await ce(a)).data[0];y(N),F(Ca(N.identificacion)),D(N.identificacion.validar)}catch(r){h.error("Error al cargar identificación: "+r.message)}})()},[a]),c.useEffect(()=>{b(t.continuar===1)},[t.continuar,b]);const f=(r,N)=>F(C=>({...C,[r]:N})),w=async()=>{if(!(g||x||i)){if(!t.idTipoSolicitud||!t.idTipoCliente||!t.idTipoDocumento||!t.numeroDocumento||!t.nombres||!t.apellidoPaterno||!t.apellidoMaterno)return u.error("Por favor llena todos los campos antes de validar."),!1;T(!0),u.info("Iniciando validación...");try{const r=await ua(t.numeroDocumento);if(r.success){const C=r.resultado;f("equifax",C.error?"Error":C.resultado?"Paso":"Rechazado"),f("obsEquifax",C.observacion||"Sin observación")}else f("equifax","Error"),f("obsEquifax","Error en validación Equifax");const N=await ma({identificacion:t.numeroDocumento,primerNombre:t.nombres.split(" ")[0]||"",segundoNombre:t.nombres.split(" ")[1]||"",primerApellido:t.apellidoPaterno,segundoApellido:t.apellidoMaterno});if(N.success){const C=N.resultado;f("listasControl",C.error?"Error":C.coincidencia?"Rechazado":"Paso"),f("obsListasControl",C.mensaje||"Sin observación")}else f("listasControl","Error"),f("obsListasControl","Error en validación LDS");return D(!0),u.success("Validación completada"),!0}catch{return u.error("Ocurrió un error durante la validación."),!1}finally{T(!1)}}},o=async()=>{if(!(!I||i)){n(!0);try{const r={...I,identificacion:{tipoSolicitud:t.idTipoSolicitud,tipoCliente:t.idTipoCliente,tipoDocumento:t.idTipoDocumento,numeroDocumento:t.numeroDocumento,nombres:t.nombres,apellidoPaterno:t.apellidoPaterno,apellidoMaterno:t.apellidoMaterno,validar:t.validar,equifax:t.equifax,obsEquifax:t.obsEquifax,listasControl:t.listasControl,obsListasControl:t.obsListasControl,continuar:t.continuar}};(await re(a,r)).success?h.success("Identificación actualizada."):h.error("Error al actualizar identificación.")}catch(r){h.error("Error al guardar: "+r.message)}finally{n(!1)}}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800",children:"Identificación"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Na,{label:"Validar",checked:t.validar,disabled:i,onChange:async r=>{if(!g&&!x&&!i){if(!r)return f("validar",!1);const N=await w();f("validar",N)}}}),g&&e.jsxs("span",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(ca,{className:"mr-2 h-4 w-4 animate-spin"}),"Consultando..."]}),x&&!i&&e.jsx("button",{onClick:()=>D(!1),className:"text-sm text-gray-200 bg-primary hover:bg-primary/80 hover:text-white px-4 py-1.5 rounded-md ml-4",children:"Editar datos"})]})]}),i&&e.jsx("div",{className:"w-full flex items-center px-6 py-2 mb-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-800 font-semibold",children:e.jsx("span",{children:"No se permite editar la identificación en esta fase."})}),e.jsx(Me,{}),e.jsx(Y,{className:"shadow-md rounded-2xl bg-white border border-gray-200",children:e.jsxs(_,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(xe,{label:"Tipo de solicitud",options:S.map(r=>({id:r.idTipoDeSolicitud,label:r.nombreTipoDeSolicitud})),value:t.idTipoSolicitud,onChange:r=>f("idTipoSolicitud",r),disabled:x||i}),e.jsx(xe,{label:"Tipo de cliente",options:E.map(r=>({id:r.idTipoCliente,label:r.nombreTipoCliente})),value:t.idTipoCliente,onChange:r=>f("idTipoCliente",r),disabled:x||i}),e.jsx(xe,{label:"Tipo de documento",options:P.map(r=>({id:r.idTipoIdentificacion,label:r.tipo})),value:t.idTipoDocumento,onChange:r=>f("idTipoDocumento",r),disabled:x||i}),e.jsx(fe,{label:"Número de identificación",value:t.numeroDocumento,onChange:r=>f("numeroDocumento",r.target.value),disabled:x||i}),e.jsx(fe,{label:"Nombres",value:t.nombres,onChange:r=>f("nombres",r.target.value),disabled:x||i}),e.jsx(fe,{label:"Apellido paterno",value:t.apellidoPaterno,onChange:r=>f("apellidoPaterno",r.target.value),disabled:x||i}),e.jsx(fe,{label:"Apellido materno",value:t.apellidoMaterno,onChange:r=>f("apellidoMaterno",r.target.value),disabled:x||i})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Z,{onClick:o,disabled:j||i,className:"text-gray-200 bg-primary hover:bg-primary/80",children:j?"Guardando...":"Guardar Identificación"})})]})}),t.validar&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-800",children:"Validación"}),e.jsx(Me,{}),e.jsx(Y,{className:"shadow-md rounded-2xl bg-white border border-gray-200",children:e.jsx(_,{className:"p-6 space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(fe,{label:"Identidad (Equifax)",value:t.equifax,disabled:!0}),e.jsx(He,{label:"Observación Equifax",value:t.obsEquifax,disabled:!0}),e.jsx(fe,{label:"Listas de Control (LDS)",value:t.listasControl,disabled:!0}),e.jsx(He,{label:"Observación LDS",value:t.obsListasControl,disabled:!0}),e.jsx(xe,{label:"Continuar",value:t.continuar,onChange:r=>f("continuar",Number(r)),options:m,full:!0,disabled:t.equifax==="Rechazado"||t.listasControl==="Rechazado"||i})]})})})]})]})}function fe({label:a,value:i,onChange:u,disabled:b}){return e.jsxs("div",{className:"space-y-1",children:[e.jsx($,{className:"text-sm text-gray-700 font-medium",children:a}),e.jsx(q,{value:i,onChange:u,disabled:b,className:"text-sm border-black",placeholder:a})]})}function xe({label:a,value:i,onChange:u,options:b,full:S=!1,disabled:s}){return e.jsxs("div",{className:`space-y-1 ${S?"md:col-span-2":""}`,children:[e.jsx($,{className:"text-sm text-gray-700 font-medium",children:a}),e.jsxs(O,{value:i!=null?String(i):void 0,onValueChange:E=>u(Number(E)),disabled:s,children:[e.jsx(G,{className:"text-sm border-black",children:e.jsx(L,{placeholder:a})}),e.jsx(V,{className:"bg-white",children:b.map(E=>e.jsx(k,{value:String(E.id),children:E.label},E.id))})]})]})}function Na({label:a,checked:i,onChange:u,disabled:b}){return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ue,{checked:i,onCheckedChange:u,disabled:b,className:`
            peer
            inline-flex
            h-6 w-11 shrink-0
            cursor-pointer
            items-center
            rounded-full
            border
            border-black
            transition-colors
            duration-200
            ease-in-out
            ${i?"bg-primary":"bg-gray-300"}
          `}),e.jsx("span",{className:`
            pointer-events-none
            absolute
            left-0.5 top-0.5
            h-5 w-5
            transform
            rounded-full
            bg-white
            shadow
            transition-transform
            duration-200
            ease-in-out
            ${i?"translate-x-5":"translate-x-0"}
          `})]}),e.jsx($,{className:"text-sm font-medium text-gray-700",children:a})]})}function He({label:a,value:i,disabled:u}){return e.jsxs("div",{className:"space-y-1",children:[e.jsx($,{className:"text-sm text-gray-700 font-medium",children:a}),e.jsx("textarea",{rows:3,value:i,disabled:u,placeholder:a,className:"w-full text-sm rounded-md border border-gray-700 px-3 py-2 resize-none"})]})}const Le=async a=>{if(!a.ok){const i=await a.text();throw new Error(i||"Error en la solicitud")}return await a.json()},Ve=()=>{var i;return{"Content-Type":"application/json",Authorization:`Bearer ${(i=JSON.parse(localStorage.getItem("user")))==null?void 0:i.token}`}},Sa=async()=>{const a=await fetch(`${U}/vista/asesorcomercial`,{headers:Ve()});return Le(a)},wa=async()=>{const a=await fetch(`${U}/JustificativoTransaccion`,{headers:Ve()});return Le(a)},Ta=async()=>{const a=await fetch(`${U}/OrigenCliente`,{headers:Ve()});return Le(a)};function Ye(a){if(!a)return"-";const i=a.split("T")[0].split("-");if(i.length!==3)return"-";const[u,b,S]=i.map(Number);return!u||!b||!S?"-":new Date(u,b-1,S).toLocaleDateString(void 0,{year:"numeric",month:"2-digit",day:"2-digit"})}function Ea(a,i=2){return a==null?"-":a.toLocaleString(void 0,{minimumFractionDigits:i,maximumFractionDigits:i})}function bi({bloquearEdicion:a=!1}){const{id:i}=we(),[u,b]=c.useState(null),[S,s]=c.useState([]),[E,l]=c.useState([]),[P,v]=c.useState([]),[I,y]=c.useState([]),[g,T]=c.useState(!0),[x,D]=c.useState(!1),[j,n]=c.useState(!1),[t,F]=c.useState(!1),[m,f]=c.useState({idAsesorComercial:"",idJustificativoTransaccion:"",idProyeccionSeleccionada:"",origenFondos:"",enviarProyeccion:!1,clienteAcepta:!1}),w=Array.isArray(S)&&S.length>0,o=!!m.clienteAcepta,r=a||!w||o;c.useEffect(()=>{(async()=>{var z,A,ae,ie,H;T(!0);try{if(i){const Q=(await ce(i)).data[0];b(Q),f({idAsesorComercial:((z=Q.proyeccion)==null?void 0:z.idAsesorComercial)||"",idJustificativoTransaccion:((A=Q.proyeccion)==null?void 0:A.idJustificativoTransaccion)||"",idProyeccionSeleccionada:((ae=Q.proyeccion)==null?void 0:ae.idProyeccionSeleccionada)||"",origenFondos:((ie=Q.proyeccion)==null?void 0:ie.origenFondos)||"",enviarProyeccion:!1,clienteAcepta:!!((H=Q.proyeccion)!=null&&H.clienteAcepta)})}const[ne,le,d,J]=await Promise.all([ba(i).catch(()=>({proyecciones:[]})),Sa().catch(()=>[]),wa().catch(()=>[]),Ta().catch(()=>[])]);s(ne.proyecciones||[]),l(le||[]),v(d||[]),y(J||[])}catch(ne){h.error("Error al cargar los datos de la solicitud."+ne.message)}finally{T(!1)}})()},[i,x]);const N=async()=>{if(!u)return;const p=!m.idAsesorComercial||!m.idJustificativoTransaccion||!m.idProyeccionSeleccionada||!m.origenFondos;if(!w||p){n(!0);return}try{T(!0);const z={...u,identificacion:te(u.identificacion),proyeccion:{...m,enviarProyeccion:!1}};(await re(i,z)).success?h.success("Datos guardados exitosamente."):h.error("Error al guardar los datos.")}catch(z){h.error("Error al guardar los datos."+z.message)}finally{T(!1)}},C=p=>{if(!m.idAsesorComercial||!m.idJustificativoTransaccion||!m.idProyeccionSeleccionada||!m.origenFondos){n(!0);return}p?F(!0):f({...m,clienteAcepta:!1})},B=async()=>{F(!1),f(p=>({...p,clienteAcepta:!0}));try{T(!0);const p={...u,identificacion:te(u.identificacion),proyeccion:{...m,clienteAcepta:!0,enviarProyeccion:!1}};(await re(i,p)).success?h.success("Aceptación guardada y proyección bloqueada."):h.error("Error al guardar la aceptación.")}catch(p){h.error("Error al guardar la aceptación."+p.message)}finally{T(!1)}},M=[{key:"idProyeccion",label:"",render:p=>e.jsxs("div",{className:"flex items-center justify-center group relative text-gray-500 cursor-default",children:[e.jsx(la,{className:"w-5 h-5"}),e.jsxs("span",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-1 text-xs text-white bg-zinc-800 px-2 py-0.5 rounded shadow opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-50",children:["ID: ",p]})]})},{key:"proyeccionNombre",label:"Nombre"},{key:"tasa",label:"Tasa (%)",render:p=>p!=null?`${p.toFixed(2)}%`:"-"},{key:"capital",label:"Capital",render:p=>Ea(p)},{key:"fechaInicial",label:"Fecha Inicial",render:p=>Ye(p)},{key:"fechaVencimiento",label:"Fecha Vencimiento",render:p=>Ye(p)}];return e.jsxs("div",{className:"space-y-6 px-4 sm:px-6 py-6 relative",children:[e.jsx(se,{visible:g,message:"Cargando datos..."}),a&&e.jsx("div",{className:"w-full flex items-center px-6 py-2 mb-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-800 font-semibold",children:e.jsx("span",{children:"No se permite editar la proyección en esta fase."})}),!g&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Proyecciones vinculadas"}),e.jsx(Y,{children:e.jsx(_,{className:"space-y-6 px-4 sm:px-6 py-6",children:w?e.jsx(Be,{columns:M,data:S,mostrarAgregarNuevo:!o&&!a,onAgregarNuevoClick:()=>D(!0),mostrarEditar:!1,mostrarEliminar:!1}):e.jsxs("div",{className:"py-6 text-center text-gray-500",children:["No se encontraron proyecciones vinculadas.",e.jsx("br",{}),e.jsx(Z,{className:"mt-4",onClick:()=>D(!0),disabled:a||o,children:"Crear nueva proyección"})]})})}),e.jsx(Y,{children:e.jsxs(_,{className:"p-6 space-y-6",children:[e.jsx(Z,{onClick:N,disabled:r,className:"text-white bg-primary hover:bg-primary/85",children:"Guardar datos"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4",children:[e.jsx(be,{label:"Asesor comercial",children:e.jsxs(O,{value:m.idAsesorComercial?String(m.idAsesorComercial):"",onValueChange:p=>f({...m,idAsesorComercial:Number(p)}),disabled:r,children:[e.jsx(G,{className:"bg-white border border-black",children:e.jsx(L,{placeholder:"-Selecciona un asesor-"})}),e.jsx(V,{className:"bg-white",children:E.map(p=>e.jsx(k,{value:String(p.idUsuario),children:p.nombreCompleto},p.idUsuario))})]})}),e.jsx(be,{label:"Justificativo de transacción",children:e.jsxs(O,{value:m.idJustificativoTransaccion?String(m.idJustificativoTransaccion):"",onValueChange:p=>f({...m,idJustificativoTransaccion:Number(p)}),disabled:r,children:[e.jsx(G,{className:"bg-white border border-black",children:e.jsx(L,{placeholder:"-Selecciona un justificativo-"})}),e.jsx(V,{className:"bg-white",children:P.map(p=>e.jsx(k,{value:String(p.idJustificativoTransaccion),children:p.nombre},p.idJustificativoTransaccion))})]})}),e.jsx(be,{label:"Proyección seleccionada",children:e.jsxs(O,{value:m.idProyeccionSeleccionada?String(m.idProyeccionSeleccionada):"",onValueChange:p=>f({...m,idProyeccionSeleccionada:Number(p)}),disabled:r,children:[e.jsx(G,{className:"bg-white border border-black",children:e.jsx(L,{placeholder:"-Selecciona una proyección-"})}),e.jsx(V,{className:"bg-white",children:S.map(p=>e.jsx(k,{value:String(p.idProyeccion),children:p.proyeccionNombre},p.idProyeccion))})]})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(be,{label:"Origen de fondos",children:e.jsx("textarea",{className:"w-full border border-black rounded-md px-3 py-2 text-sm",rows:3,placeholder:"Describe el origen de los fondos",value:m.origenFondos,onChange:p=>f({...m,origenFondos:p.target.value}),disabled:r})})}),e.jsx(be,{label:"Aceptación del cliente",children:e.jsx(Pa,{label:m.clienteAcepta?"El Cliente Acepta":"El Cliente No Acepta",checked:m.clienteAcepta,onChange:C,disabled:r})})]})]})}),e.jsx(ze,{open:x,onOpenChange:D,children:e.jsxs(Oe,{className:"w-full max-w-4xl max-h-[calc(100vh-4rem)] overflow-y-auto p-4",children:[e.jsx(xa,{}),e.jsx(Ge,{children:e.jsx(Z,{variant:"outline",onClick:()=>D(!1),children:"Cancelar"})})]})}),e.jsx(je,{open:j,onOpenChange:n,children:e.jsxs(ve,{className:"bg-white border border-gray-200 rounded-xl shadow-xl",children:[e.jsxs(ye,{children:[e.jsx(Ce,{className:"text-violet-700 font-semibold",children:"Faltan campos obligatorios"}),e.jsx("div",{className:"text-gray-700 mt-2",children:"Para continuar, debes llenar todos los campos y tener al menos una proyección creada y seleccionada."})]}),e.jsxs(Ne,{children:[e.jsx(Se,{className:"border border-gray-300 bg-white hover:bg-gray-50",children:"Cerrar"}),e.jsx(Ue,{asChild:!0,children:e.jsx("button",{className:"bg-violet-600 text-white hover:bg-violet-700 px-4 py-2 rounded",onClick:()=>n(!1),type:"button",children:"OK"})})]})]})}),e.jsx(je,{open:t,onOpenChange:F,children:e.jsxs(ve,{className:"bg-white border border-yellow-300 rounded-xl shadow-xl p-7 max-w-md",children:[e.jsxs(ye,{children:[e.jsx(Ce,{className:"text-yellow-700 font-semibold",children:"Confirmar aceptación"}),e.jsx("div",{className:"text-gray-700 mt-2",children:"¿Estás seguro de aceptar la proyección? No podrás editarla nuevamente."})]}),e.jsxs(Ne,{children:[e.jsx(Se,{className:"border border-gray-300 bg-white hover:bg-gray-50",onClick:()=>{F(!1)},children:"Cancelar"}),e.jsx(Ue,{asChild:!0,children:e.jsx("button",{className:"bg-violet-600 text-white hover:bg-violet-700 px-4 py-2 rounded",onClick:B,type:"button",children:"Aceptar"})})]})]})})]})]})}function be({label:a,children:i}){return e.jsxs("div",{className:"space-y-1",children:[e.jsx($,{className:"text-sm text-gray-700 font-medium",children:a}),i]})}function Pa({label:a,checked:i,onChange:u,disabled:b}){return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ue,{checked:i,onCheckedChange:u,disabled:b,className:`
            peer
            inline-flex
            h-6 w-11 shrink-0
            cursor-pointer
            items-center
            rounded-full
            border
            border-gray-400
            transition-colors
            duration-200
            ease-in-out
            ${i?"bg-primary":"bg-gray-300"}
          `}),e.jsx("span",{className:`
            pointer-events-none
            absolute
            left-0.5 top-0.5
            h-5 w-5
            transform
            rounded-full
            bg-white
            shadow
            transition-transform
            duration-200
            ease-in-out
            ${i?"translate-x-5":"translate-x-0"}
          `})]}),e.jsx($,{className:"text-sm font-light text-gray-700",children:a})]})}const Te=()=>{var i;return{"Content-Type":"application/json",Authorization:`Bearer ${(i=JSON.parse(localStorage.getItem("user")))==null?void 0:i.token}`}},Ee=async a=>{if(!a.ok){const i=await a.text();throw new Error(i||"Error en la solicitud")}return await a.json()},Fe=async a=>{const i=await fetch(`${U}/vista/referencia/filtrar?por=idSolicitudInversion&id=${a}`,{headers:Te()});return Ee(i)},Da=async a=>{const i=await fetch(`${U}/referencia`,{method:"POST",headers:Te(),body:JSON.stringify(a)});return Ee(i)},Aa=async(a,i)=>{const u=await fetch(`${U}/referencia/${a}`,{method:"PUT",headers:Te(),body:JSON.stringify(i)});return Ee(u)},Ra=async a=>{const i=await fetch(`${U}/referencia/${a}`,{method:"DELETE",headers:Te()});return Ee(i)},ka=async a=>{if(!a.ok){const i=await a.text();throw new Error(i||"Error en la solicitud")}return await a.json()},Ia=()=>{var i;return{"Content-Type":"application/json",Authorization:`Bearer ${(i=JSON.parse(localStorage.getItem("user")))==null?void 0:i.token}`}},Fa=async()=>{const a=await fetch(`${U}/TipoReferencia`,{headers:Ia()});return ka(a)},Je=()=>{var i;return{"Content-Type":"application/json",Authorization:`Bearer ${(i=JSON.parse(localStorage.getItem("user")))==null?void 0:i.token}`}},qe=async a=>{if(!a.ok){const i=await a.text();throw new Error(i||"Error en la solicitud")}return a.json()},$a=async()=>{const a=await fetch(`${U}/Nacionalidad`,{headers:Je()});return qe(a)},Ua=async()=>{const a=await fetch(`${U}/Profesion`,{headers:Je()});return qe(a)},Ba=async()=>{const a=await fetch(`${U}/Etnia`,{headers:Je()});return qe(a)};function xi(){var le;const{user:a}=Xe(),{id:i}=we(),[u,b]=c.useState(!0),[S,s]=c.useState([]),[E,l]=c.useState([]),[P,v]=c.useState([]),[I,y]=c.useState(null),[g,T]=c.useState({fechaNacimiento:"",genero:"",estadoCivil:"",nivelAcademico:"",numeroCargasFamiliares:"",nacionalidad:"",profesion:"",etnia:"",paisNacimiento:"",provinciaNacimiento:"",ciudadNacimiento:""}),[x,D]=c.useState({}),[j,n]=c.useState(!1);c.useEffect(()=>{(async()=>{var J,K,Q,ge;b(!0);try{const me=(await ce(i)).data[0];y(me),n(me.faseProceso!==1);const W=me.datosGenerales||{};T({fechaNacimiento:W.fechaNacimiento?W.fechaNacimiento.split("T")[0]:"",genero:((J=W.idGenero)==null?void 0:J.toString())||"",estadoCivil:((K=W.idEstadoCivil)==null?void 0:K.toString())||"",nivelAcademico:((Q=W.idNivelAcademico)==null?void 0:Q.toString())||"",numeroCargasFamiliares:((ge=W.numeroCargasFamiliares)==null?void 0:ge.toString())||"",nacionalidad:W.idNacionalidad||"",profesion:W.idProfesion||"",etnia:W.idEtnia||"",paisNacimiento:"",provinciaNacimiento:"",ciudadNacimiento:""});const[R,ke,Ie]=await Promise.all([Ba(),$a(),Ua()]);s(R),l(ke),v(Ie)}catch(he){h.error("Error al cargar datos generales: "+he.message)}finally{b(!1)}})()},[i]);const[t,F]=c.useState([]),[m,f]=c.useState([]),[w,o]=c.useState(!1),[r,N]=c.useState(!1),[C,B]=c.useState({idSolicitudInversion:Number(i),idTipoReferencia:"",nombre:"",direccion:"",telefonoCelular:"",fechaCreacion:new Date().toISOString(),idUsuarioPropietario:a==null?void 0:a.idUsuario}),M=()=>!C.nombre||C.nombre.trim()===""?(h.error("El campo Nombre es obligatorio."),!1):!C.direccion||C.direccion.trim()===""?(h.error("El campo Dirección es obligatorio."),!1):!C.telefonoCelular||C.telefonoCelular.trim()===""?(h.error("El campo Teléfono Celular es obligatorio."),!1):C.idTipoReferencia?!0:(h.error("Debes seleccionar un Tipo de Referencia."),!1);c.useEffect(()=>{const d=async()=>{try{const K=await Fe(i);f(K||[])}catch{f([])}},J=async()=>{try{const K=await Fa();F(K)}catch{F([])}};d(),J()},[i]);const p=()=>{N(!1),B({idSolicitudInversion:Number(i),idTipoReferencia:"",nombre:"",direccion:"",telefonoCelular:"",fechaCreacion:new Date().toISOString(),idUsuarioPropietario:a==null?void 0:a.idUsuario}),o(!0)},z=d=>{B({idReferencia:d.idReferencia,idSolicitudInversion:Number(i),idTipoReferencia:d.idTipoReferencia,nombre:d.nombreReferencia,direccion:d.direccion,telefonoCelular:d.telefonoCelular,telefonoFijo:d.telefonoFijo||"",fechaCreacion:d.fechaCreacion,idUsuarioPropietario:a==null?void 0:a.idUsuario}),N(!0),o(!0)},A=async d=>{if(window.confirm(`¿Eliminar "${d.nombreReferencia}"?`))try{await Ra(d.idReferencia),h.success("Referencia eliminada");const J=await Fe(i);f(J||[])}catch{h.error("No se pudo eliminar la referencia")}},ae=()=>{const d={};return g.fechaNacimiento||(d.fechaNacimiento="Fecha de nacimiento es obligatoria"),g.genero||(d.genero="Género es obligatorio"),g.estadoCivil||(d.estadoCivil="Estado civil es obligatorio"),g.nivelAcademico||(d.nivelAcademico="Nivel académico es obligatorio"),g.nacionalidad||(d.nacionalidad="Nacionalidad es obligatoria"),g.profesion||(d.profesion="Profesión es obligatoria"),g.etnia||(d.etnia="Etnia es obligatoria"),D(d),Object.keys(d).length===0},ie=async()=>{if(I&&!j){if(m.length===0){h.error("Debes agregar al menos una referencia antes de guardar.");return}if(!ae()){h.error("Por favor completa todos los campos obligatorios antes de guardar.");return}b(!0);try{const d={...I,identificacion:te(I.identificacion),datosGenerales:{...I.datosGenerales,fechaNacimiento:g.fechaNacimiento,idGenero:parseInt(g.genero)||null,idEstadoCivil:parseInt(g.estadoCivil)||null,idNivelAcademico:parseInt(g.nivelAcademico)||null,numeroCargasFamiliares:parseInt(g.numeroCargasFamiliares)||0,idNacionalidad:g.nacionalidad,idProfesion:g.profesion,idEtnia:g.etnia}};(await re(i,d)).success?h.success("Datos generales actualizados."):h.error("Error al actualizar datos generales.")}catch(d){h.error("Error al guardar datos generales: "+d.message)}finally{b(!1)}}},H=async()=>{if(j||!M())return;const d={...C,fechaCreacion:new Date().toISOString()};try{r?(await Aa(C.idReferencia,d),h.success("Referencia actualizada",{description:`Se actualizó ${C.nombre}`})):(await Da(d),h.success("Referencia creada",{description:`Se agregó ${C.nombre}`}));const J=await Fe(i);f(J),o(!1),N(!1),B({idSolicitudInversion:Number(i),idTipoReferencia:"",nombre:"",direccion:"",telefonoCelular:"",fechaCreacion:new Date().toISOString(),idUsuarioPropietario:a==null?void 0:a.idUsuario})}catch{h.error("No se pudo guardar la referencia.")}},ne=[{key:"idReferencia",label:"",render:d=>e.jsx("span",{title:`ID Referencia: ${d}`,className:"flex justify-center cursor-default text-gray-600 hover:text-gray-900",children:e.jsx(ea,{size:18})})},{key:"nombreReferencia",label:"Nombre Referencia"},{key:"nombreTipoReferencia",label:"Tipo Referencia"},{key:"telefonoCelular",label:"Teléfono Celular"},{key:"direccion",label:"Dirección"},{key:"fechaCreacion",label:"Fecha de Creación"}];return e.jsxs("div",{className:"space-y-6 p-6 relative",children:[e.jsx(se,{visible:u,message:"Cargando datos generales..."}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Datos generales"}),j&&e.jsx("div",{className:"w-full flex items-center px-6 py-2 mb-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-800 font-semibold",children:e.jsx("span",{children:"No se permite editar datos generales en esta fase."})}),e.jsx(Y,{children:e.jsxs(_,{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex justify-end",children:e.jsx(Z,{onClick:ie,disabled:j,className:"bg-primary text-gray-200 hover:text-white hover:bg-primary/80 hover:shadow-md",children:"Guardar Datos Generales"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsx(ee,{label:"Fecha de nacimiento",error:x.fechaNacimiento,children:e.jsx(q,{type:"date",value:g.fechaNacimiento,onChange:d=>T({...g,fechaNacimiento:d.target.value}),disabled:j,"aria-invalid":!!x.fechaNacimiento})}),e.jsx(ee,{label:"Género",error:x.genero,children:e.jsxs(O,{value:g.genero,onValueChange:d=>T({...g,genero:d}),disabled:j,"aria-invalid":!!x.genero,children:[e.jsx(G,{className:"bg-white border border-gray-700",children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsxs(V,{className:"bg-white",children:[e.jsx(k,{value:"1",children:"Masculino"}),e.jsx(k,{value:"2",children:"Femenino"}),e.jsx(k,{value:"3",children:"Otro"})]})]})}),e.jsx(ee,{label:"Estado civil",error:x.estadoCivil,children:e.jsxs(O,{value:g.estadoCivil,onValueChange:d=>T({...g,estadoCivil:d}),disabled:j,"aria-invalid":!!x.estadoCivil,children:[e.jsx(G,{className:"bg-white border border-gray-700",children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsxs(V,{className:"bg-white",children:[e.jsx(k,{value:"1",children:"Soltero"}),e.jsx(k,{value:"2",children:"Casado"}),e.jsx(k,{value:"3",children:"Divorciado"})]})]})}),e.jsx(ee,{label:"Nivel académico",error:x.nivelAcademico,children:e.jsxs(O,{value:g.nivelAcademico,onValueChange:d=>T({...g,nivelAcademico:d}),disabled:j,"aria-invalid":!!x.nivelAcademico,children:[e.jsx(G,{className:"bg-white border border-gray-700",children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsxs(V,{className:"bg-white",children:[e.jsx(k,{value:"1",children:"Primaria"}),e.jsx(k,{value:"2",children:"Secundaria"}),e.jsx(k,{value:"3",children:"Universitaria"})]})]})}),e.jsx(ee,{label:"Nacionalidad",error:x.nacionalidad,children:e.jsxs(O,{value:g.nacionalidad,onValueChange:d=>T({...g,nacionalidad:d}),disabled:j,"aria-invalid":!!x.nacionalidad,children:[e.jsx(G,{className:"bg-white border border-gray-700",children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsx(V,{className:"bg-white",children:E.map(d=>e.jsx(k,{value:d.idNacionalidad,children:d.nombre},d.idNacionalidad))})]})}),e.jsx(ee,{label:"Profesión",error:x.profesion,children:e.jsxs(O,{value:g.profesion,onValueChange:d=>T({...g,profesion:d}),disabled:j,"aria-invalid":!!x.profesion,children:[e.jsx(G,{className:"bg-white border border-gray-700",children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsx(V,{className:"bg-white",children:P.map(d=>e.jsx(k,{value:d.idProfesion,children:d.nombre},d.idProfesion))})]})}),e.jsx(ee,{label:"Etnia",error:x.etnia,children:e.jsxs(O,{value:g.etnia,onValueChange:d=>T({...g,etnia:d}),disabled:j,"aria-invalid":!!x.etnia,children:[e.jsx(G,{className:"bg-white border border-gray-700",children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsx(V,{className:"bg-white",children:S.map(d=>e.jsx(k,{value:d.idEtnia,children:d.nombre},d.idEtnia))})]})})]})]})}),e.jsx(Y,{children:e.jsxs(_,{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-4",children:"Referencias personales y comerciales"}),e.jsx(Be,{columns:ne,data:m,mostrarEditar:!j,mostrarAgregarNuevo:!j,mostrarEliminar:!j,onAgregarNuevoClick:p,onEditarClick:z,onEliminarClick:A})]})}),e.jsx(ze,{open:w,onOpenChange:o,children:e.jsxs(Oe,{children:[e.jsx(aa,{children:e.jsx(ia,{children:r?"Editar referencia":"Agregar nueva referencia"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(ee,{label:"Nombre",children:e.jsx(q,{value:C.nombre,onChange:d=>B({...C,nombre:d.target.value}),disabled:j})}),e.jsx(ee,{label:"Dirección",children:e.jsx(q,{value:C.direccion,onChange:d=>B({...C,direccion:d.target.value}),disabled:j})}),e.jsx(ee,{label:"Teléfono Celular",children:e.jsx(q,{value:C.telefonoCelular,onChange:d=>B({...C,telefonoCelular:d.target.value}),disabled:j})}),e.jsx(ee,{label:"Tipo de Referencia",children:e.jsxs(O,{value:(le=C.idTipoReferencia)==null?void 0:le.toString(),onValueChange:d=>B({...C,idTipoReferencia:Number(d)}),disabled:j,children:[e.jsx(G,{className:"bg-white border border-gray-700",children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsx(V,{className:"bg-white",children:t.map(d=>e.jsx(k,{value:d.idTipoReferencia.toString(),children:d.nombre},d.idTipoReferencia))})]})})]}),e.jsx(Ge,{className:"pt-4",children:e.jsx(Z,{className:"text-gray-300 hover:text-white",onClick:H,disabled:j,children:r?"Actualizar":"Crear"})})]})})]})}function ee({label:a,children:i,error:u}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs($,{className:"text-sm font-medium text-gray-700 flex items-center gap-1",children:[a," ",u&&e.jsx("span",{className:"text-red-600 text-xs italic",children:u})]}),i]})}const oa=async a=>{if(!a.ok){const i=await a.text();throw new Error(i||"Error en la solicitud")}return await a.json()},ra=()=>{var i;return{"Content-Type":"application/json",Authorization:`Bearer ${(i=JSON.parse(localStorage.getItem("user")))==null?void 0:i.token}`}},za=async()=>{const a=await fetch(`${U}/ActividadEconomicaPrincipal`,{headers:ra()});return oa(a)},Oa=async()=>{const a=await fetch(`${U}/ActividadEconomicaLugarTrabajo`,{headers:ra()});return oa(a)};function pi(){const{id:a}=we(),[i,u]=c.useState(!0),[b,S]=c.useState(null),[s,E]=c.useState([]),[l,P]=c.useState([]),[v,I]=c.useState(!1),[y,g]=c.useState({idActividadEconomicaPrincipal:"",idActividadEconomicaLugarTrabajo:"",lugarTrabajo:"",correoTrabajo:"",otraActividadEconomica:"",cargo:"",antiguedad:"",telefonoTrabajo:"",fechaInicioActividad:"",direccionTrabajo:"",referenciaDireccionTrabajo:"",isPEP:!1}),[T,x]=c.useState({});c.useEffect(()=>{(async()=>{var t,F,m,f,w,o,r,N,C,B,M,p;u(!0);try{const A=(await ce(a)).data[0];S(A),I(A.faseProceso!==1),g({idActividadEconomicaPrincipal:((t=A.actividadEconomica)==null?void 0:t.idActividadEconomicaPrincipal)||"",idActividadEconomicaLugarTrabajo:((F=A.actividadEconomica)==null?void 0:F.idActividadEconomicaLugarTrabajo)||"",lugarTrabajo:((m=A.actividadEconomica)==null?void 0:m.lugarTrabajo)||"",correoTrabajo:((f=A.actividadEconomica)==null?void 0:f.correoTrabajo)||"",otraActividadEconomica:((w=A.actividadEconomica)==null?void 0:w.otraActividadEconomica)||"",cargo:((o=A.actividadEconomica)==null?void 0:o.cargo)||"",antiguedad:((r=A.actividadEconomica)==null?void 0:r.antiguedad)||"",telefonoTrabajo:((N=A.actividadEconomica)==null?void 0:N.telefonoTrabajo)||"",fechaInicioActividad:(C=A.actividadEconomica)!=null&&C.fechaInicioActividad?A.actividadEconomica.fechaInicioActividad.split("T")[0]:"",direccionTrabajo:((B=A.actividadEconomica)==null?void 0:B.direccionTrabajo)||"",referenciaDireccionTrabajo:((M=A.actividadEconomica)==null?void 0:M.referenciaDireccionTrabajo)||"",isPEP:((p=A.actividadEconomica)==null?void 0:p.esPEP)||!1});const[ae,ie]=await Promise.all([za(),Oa()]);E(ae.map(H=>({id:String(H.idActividadEconomicaPrincipal),nombre:H.nombre}))),P(ie.map(H=>({id:String(H.idActividadEconomicaLugarTrabajo),nombre:H.nombre})))}catch(z){h.error("Error al cargar datos: "+z.message)}finally{u(!1)}})()},[a]);const D=()=>{const n={};return y.idActividadEconomicaPrincipal||(n.idActividadEconomicaPrincipal="Actividad económica principal es obligatoria"),y.idActividadEconomicaLugarTrabajo||(n.idActividadEconomicaLugarTrabajo="Actividad económica del lugar de trabajo es obligatoria"),y.lugarTrabajo||(n.lugarTrabajo="Lugar de trabajo es obligatorio"),y.cargo||(n.cargo="Cargo es obligatorio"),y.telefonoTrabajo||(n.telefonoTrabajo="Teléfono del trabajo es obligatorio"),y.fechaInicioActividad||(n.fechaInicioActividad="Fecha de inicio es obligatoria"),y.antiguedad||(n.antiguedad="Antigüedad es obligatoria"),y.correoTrabajo||(n.correoTrabajo="Correo electrónico del trabajo es obligatorio"),y.direccionTrabajo||(n.direccionTrabajo="Dirección del trabajo es obligatoria"),y.referenciaDireccionTrabajo||(n.referenciaDireccionTrabajo="Referencia de la dirección del trabajo es obligatoria"),x(n),Object.keys(n).length===0},j=async()=>{if(!(!b||v)){if(!D()){h.error("Por favor completa todos los campos obligatorios.");return}u(!0);try{const n={...b,identificacion:te(b.identificacion),actividadEconomica:{...b.actividadEconomica,...y,esPEP:y.isPEP}};(await re(a,n)).success?h.success("Datos guardados exitosamente."):h.error("Error al guardar los datos.")}catch(n){h.error("Error al guardar los datos: "+n.message)}finally{u(!1)}}};return e.jsxs("div",{className:"space-y-6 p-6 relative",children:[e.jsx(se,{visible:i,message:"Cargando datos..."}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Actividad económica"}),v&&e.jsx("div",{className:"w-full flex items-center px-6 py-2 mb-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-800 font-semibold",children:e.jsx("span",{children:"No se permite editar actividad económica en esta fase."})}),e.jsx(Y,{children:e.jsxs(_,{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex justify-end",children:e.jsx(Z,{onClick:j,disabled:v||i,className:"text-white bg-primary hover:bg-primary/80",children:"Guardar datos"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsx(_e,{label:"Actividad económica principal",options:s,value:y.idActividadEconomicaPrincipal,onChange:n=>g(t=>({...t,idActividadEconomicaPrincipal:n})),disabled:v,error:T.idActividadEconomicaPrincipal}),e.jsx(_e,{label:"Actividad económica del lugar de trabajo",options:l,value:y.idActividadEconomicaLugarTrabajo,onChange:n=>g(t=>({...t,idActividadEconomicaLugarTrabajo:n})),disabled:v,error:T.idActividadEconomicaLugarTrabajo}),e.jsx(oe,{label:"Otra actividad económica",value:y.otraActividadEconomica,onChange:n=>g(t=>({...t,otraActividadEconomica:n.target.value})),disabled:v}),e.jsx(oe,{label:"Lugar de trabajo",value:y.lugarTrabajo,onChange:n=>g(t=>({...t,lugarTrabajo:n.target.value})),disabled:v,error:T.lugarTrabajo}),e.jsx(oe,{label:"Cargo",value:y.cargo,onChange:n=>g(t=>({...t,cargo:n.target.value})),disabled:v,error:T.cargo}),e.jsx(oe,{label:"Teléfono del trabajo",value:y.telefonoTrabajo,onChange:n=>g(t=>({...t,telefonoTrabajo:n.target.value})),disabled:v,error:T.telefonoTrabajo}),e.jsx(oe,{label:"Fecha de inicio",type:"date",value:y.fechaInicioActividad,onChange:n=>g(t=>({...t,fechaInicioActividad:n.target.value})),disabled:v,error:T.fechaInicioActividad}),e.jsx(oe,{label:"Antigüedad (años)",value:y.antiguedad,onChange:n=>g(t=>({...t,antiguedad:n.target.value})),disabled:v,error:T.antiguedad}),e.jsx(oe,{label:"Correo electrónico del trabajo",value:y.correoTrabajo,onChange:n=>g(t=>({...t,correoTrabajo:n.target.value})),disabled:v,error:T.correoTrabajo}),e.jsx(oe,{label:"Dirección del trabajo",value:y.direccionTrabajo,onChange:n=>g(t=>({...t,direccionTrabajo:n.target.value})),disabled:v,error:T.direccionTrabajo}),e.jsx(oe,{label:"Referencia de la dirección del trabajo",value:y.referenciaDireccionTrabajo,onChange:n=>g(t=>({...t,referenciaDireccionTrabajo:n.target.value})),disabled:v,error:T.referenciaDireccionTrabajo}),e.jsx(Ga,{label:"Es PEP",checked:y.isPEP,onChange:n=>g(t=>({...t,isPEP:n})),disabled:v})]})]})})]})}function oe({label:a,value:i,onChange:u,type:b="text",disabled:S,error:s}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs($,{className:"text-sm font-medium text-gray-700 flex items-center gap-1",children:[a," ",s&&e.jsx("span",{className:"text-red-600 text-xs italic",children:s})]}),e.jsx(q,{placeholder:"---",type:b,value:i,onChange:u,disabled:S,"aria-invalid":!!s})]})}function _e({label:a,options:i,value:u,onChange:b,disabled:S,error:s}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs($,{className:"text-sm font-medium text-gray-700 flex items-center gap-1",children:[a," ",s&&e.jsx("span",{className:"text-red-600 text-xs italic",children:s})]}),e.jsxs(O,{value:String(u),onValueChange:b,disabled:S,"aria-invalid":!!s,children:[e.jsx(G,{className:"bg-white border border-gray-700",children:e.jsx(L,{placeholder:"---"})}),e.jsx(V,{className:"bg-white",children:i.map(E=>e.jsx(k,{value:String(E.id),children:E.nombre},E.id))})]})]})}function Ga({label:a,checked:i,onChange:u,disabled:b}){return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ue,{checked:i,onCheckedChange:u,disabled:b,className:`
            peer
            inline-flex
            h-6 w-11 shrink-0
            cursor-pointer
            items-center
            rounded-full
            border
            border-gray-400
            transition-colors
            duration-200
            ease-in-out
            ${i?"bg-primary":"bg-gray-300"}
          `}),e.jsx("span",{className:`
            pointer-events-none
            absolute
            left-0.5 top-0.5
            h-5 w-5
            transform
            rounded-full
            bg-white
            shadow
            transition-transform
            duration-200
            ease-in-out
            ${i?"translate-x-5":"translate-x-0"}
          `})]}),e.jsx($,{className:"text-sm font-medium text-gray-700",children:a})]})}const Pe=()=>{var i;return{"Content-Type":"application/json",Authorization:`Bearer ${(i=JSON.parse(localStorage.getItem("user")))==null?void 0:i.token}`}},De=async a=>{if(!a.ok){const i=await a.text();throw new Error(i||"Error en la solicitud")}return a.json()},La=async()=>{const a=await fetch(`${U}/TipoVia`,{headers:Pe()});return De(a)},Va=async()=>{const a=await fetch(`${U}/Pais`,{headers:Pe()});return De(a)},Ke=async a=>{const i=await fetch(`${U}/Provincia/por-pais/${a}`,{headers:Pe()});return De(i)},Qe=async a=>{const i=await fetch(`${U}/Ciudad/por-provincia/${a}`,{headers:Pe()});return De(i)};function ji({id:a}){const[i,u]=c.useState(!0),[b,S]=c.useState(null),[s,E]=c.useState(!1),[l,P]=c.useState({correoElectronico:"",otroTelefono:"",telefonoCelular:"",telefonoFijo:"",idTipoVia:"",callePrincipal:"",numeroDomicilio:"",calleSecundaria:"",referenciaDomicilio:"",sectorBarrio:"",tiempoResidencia:"",idPaisResidencia:"",idProvinciaResidencia:"",idCiudadResidencia:"",residenteOtroPais:!1,contribuyenteEEUU:!1,numeroIdentificacionOtroPais:"",numeroIdentificacionEEUU:""}),[v,I]=c.useState([]),[y,g]=c.useState([]),[T,x]=c.useState([]),[D,j]=c.useState([]),[n,t]=c.useState({});c.useEffect(()=>{(async()=>{var r,N,C,B,M,p,z,A,ae,ie,H,ne,le,d,J,K,Q,ge,he,me;u(!0);try{const R=(await ce(a)).data[0];S(R),E(R.faseProceso!==1),P({correoElectronico:((r=R.contactoUbicacion)==null?void 0:r.correoElectronico)||"",otroTelefono:((N=R.contactoUbicacion)==null?void 0:N.otroTelefono)||"",telefonoCelular:((C=R.contactoUbicacion)==null?void 0:C.telefonoCelular)||"",telefonoFijo:((B=R.contactoUbicacion)==null?void 0:B.telefonoFijo)||"",callePrincipal:((M=R.contactoUbicacion)==null?void 0:M.callePrincipal)||"",numeroDomicilio:((p=R.contactoUbicacion)==null?void 0:p.numeroDomicilio)||"",calleSecundaria:((z=R.contactoUbicacion)==null?void 0:z.calleSecundaria)||"",referenciaDomicilio:((A=R.contactoUbicacion)==null?void 0:A.referenciaDomicilio)||"",sectorBarrio:((ae=R.contactoUbicacion)==null?void 0:ae.sectorBarrio)||"",tiempoResidencia:((ie=R.contactoUbicacion)==null?void 0:ie.tiempoResidencia)||"",idTipoVia:((H=R.contactoUbicacion)==null?void 0:H.idTipoVia)||"",idPaisResidencia:((ne=R.contactoUbicacion)==null?void 0:ne.idPaisResidencia)||"",idProvinciaResidencia:((le=R.contactoUbicacion)==null?void 0:le.idProvinciaResidencia)||"",idCiudadResidencia:((d=R.contactoUbicacion)==null?void 0:d.idCiudadResidencia)||"",residenteOtroPais:((J=R.contactoUbicacion)==null?void 0:J.residenteOtroPais)||!1,contribuyenteEEUU:((K=R.contactoUbicacion)==null?void 0:K.contribuyenteEEUU)||!1,numeroIdentificacionOtroPais:((Q=R.contactoUbicacion)==null?void 0:Q.numeroIdentificacionOtroPais)||"",numeroIdentificacionEEUU:((ge=R.contactoUbicacion)==null?void 0:ge.numeroIdentificacionEEUU)||""});const[ke,Ie]=await Promise.all([Va(),La()]);if(I(ke),j(Ie),(he=R.contactoUbicacion)!=null&&he.idPaisResidencia){const na=await Ke(R.contactoUbicacion.idPaisResidencia);if(g(na),(me=R.contactoUbicacion)!=null&&me.idProvinciaResidencia){const sa=await Qe(R.contactoUbicacion.idProvinciaResidencia);x(sa)}}}catch(W){h.error("Error al cargar contacto: "+W.message)}finally{u(!1)}})()},[a]);const F=()=>{var r,N,C,B,M,p,z;const o={};return(r=l.correoElectronico)!=null&&r.trim()||(o.correoElectronico="Correo electrónico es obligatorio"),(N=l.telefonoCelular)!=null&&N.trim()||(o.telefonoCelular="Teléfono celular es obligatorio"),l.idPaisResidencia||(o.idPaisResidencia="País de residencia es obligatorio"),l.idProvinciaResidencia||(o.idProvinciaResidencia="Provincia es obligatoria"),l.idCiudadResidencia||(o.idCiudadResidencia="Ciudad es obligatoria"),l.idTipoVia||(o.idTipoVia="Tipo de vía es obligatorio"),(C=l.callePrincipal)!=null&&C.trim()||(o.callePrincipal="Calle principal es obligatoria"),(B=l.numeroDomicilio)!=null&&B.trim()||(o.numeroDomicilio="Número de domicilio es obligatorio"),(M=l.calleSecundaria)!=null&&M.trim()||(o.calleSecundaria="Calle secundaria es obligatoria"),(p=l.referenciaDomicilio)!=null&&p.trim()||(o.referenciaDomicilio="Referencia es obligatoria"),(z=l.sectorBarrio)!=null&&z.trim()||(o.sectorBarrio="Sector o barrio es obligatorio"),(!l.tiempoResidencia||l.tiempoResidencia==="")&&(o.tiempoResidencia="Tiempo de residencia es obligatorio"),t(o),Object.keys(o).length===0},m=async()=>{if(b){if(!F()){h.error("Por favor completa todos los campos obligatorios.");return}u(!0);try{const o={...b,identificacion:te(b.identificacion),contactoUbicacion:l};(await re(a,o)).success?h.success("Contacto actualizado."):h.error("Error al actualizar contacto.")}catch(o){h.error("Error al guardar: "+o.message)}finally{u(!1)}}},f=async o=>{if(P({...l,idPaisResidencia:o,idProvinciaResidencia:"",idCiudadResidencia:""}),x([]),o){const r=await Ke(o);g(r)}else g([])},w=async o=>{if(P({...l,idProvinciaResidencia:o,idCiudadResidencia:""}),o){const r=await Qe(o);x(r)}else x([])};return e.jsxs("div",{className:"space-y-6 p-6 relative",children:[e.jsx(se,{visible:i,message:"Cargando contacto..."}),!i&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Contacto y Ubicación"}),s&&e.jsx("div",{className:"w-full flex items-center px-6 py-2 mb-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-800 font-semibold",children:e.jsx("span",{children:"No se permite editar contacto y ubicación en esta fase."})}),e.jsx(Z,{onClick:m,disabled:i||s,className:"text-white",children:"Guardar datos"}),e.jsx(Y,{children:e.jsxs(_,{className:"p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsx(X,{label:"Correo electrónico *",value:l.correoElectronico,onChange:o=>P({...l,correoElectronico:o.target.value}),disabled:s,error:n.correoElectronico}),e.jsx(X,{label:"Teléfono celular *",value:l.telefonoCelular,onChange:o=>P({...l,telefonoCelular:o.target.value}),disabled:s,error:n.telefonoCelular}),e.jsx(X,{label:"Otro teléfono",value:l.otroTelefono,onChange:o=>P({...l,otroTelefono:o.target.value}),disabled:s}),e.jsx(X,{label:"Teléfono fijo",value:l.telefonoFijo,onChange:o=>P({...l,telefonoFijo:o.target.value}),disabled:s})]})}),e.jsx(Y,{children:e.jsxs(_,{className:"p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs(pe,{label:"País de residencia *",children:[e.jsxs(O,{value:l.idPaisResidencia,onValueChange:f,disabled:s,"aria-invalid":!!n.idPaisResidencia,children:[e.jsx(G,{className:"border border-black",children:e.jsx(L,{placeholder:"---"})}),e.jsx(V,{className:"bg-white border border-gray-200 shadow-xl z-[9999]",children:v.map(o=>e.jsx(k,{value:o.idPais,children:o.nombre},o.idPais))})]}),n.idPaisResidencia&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:n.idPaisResidencia})]}),e.jsxs(pe,{label:"Provincia *",children:[e.jsxs(O,{disabled:!l.idPaisResidencia||s,value:l.idProvinciaResidencia,onValueChange:w,"aria-invalid":!!n.idProvinciaResidencia,children:[e.jsx(G,{className:"border border-black",children:e.jsx(L,{placeholder:"---"})}),e.jsx(V,{className:"bg-white border border-gray-200 shadow-xl z-[9999]",children:y.map(o=>e.jsx(k,{value:o.idProvincia,children:o.nombre},o.idProvincia))})]}),n.idProvinciaResidencia&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:n.idProvinciaResidencia})]}),e.jsxs(pe,{label:"Ciudad *",children:[e.jsxs(O,{disabled:!l.idProvinciaResidencia||s,value:l.idCiudadResidencia,onValueChange:o=>P({...l,idCiudadResidencia:o}),"aria-invalid":!!n.idCiudadResidencia,children:[e.jsx(G,{className:"border border-black",children:e.jsx(L,{placeholder:"---"})}),e.jsx(V,{className:"bg-white border border-gray-200 shadow-xl z-[9999]",children:T.map(o=>e.jsx(k,{value:o.idCiudad,children:o.nombre},o.idCiudad))})]}),n.idCiudadResidencia&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:n.idCiudadResidencia})]}),e.jsxs(pe,{label:"Tipo de vía *",children:[e.jsxs(O,{value:l.idTipoVia,onValueChange:o=>P({...l,idTipoVia:o}),disabled:s,"aria-invalid":!!n.idTipoVia,children:[e.jsx(G,{className:"border border-black",children:e.jsx(L,{placeholder:"---"})}),e.jsx(V,{className:"bg-white border border-gray-200 shadow-xl z-[9999]",children:D.map(o=>e.jsx(k,{value:o.idTipoVia,children:o.nombre},o.idTipoVia))})]}),n.idTipoVia&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:n.idTipoVia})]}),e.jsx(X,{label:"Calle principal *",value:l.callePrincipal,onChange:o=>P({...l,callePrincipal:o.target.value}),disabled:s,error:n.callePrincipal}),e.jsx(X,{label:"Número de domicilio *",value:l.numeroDomicilio,onChange:o=>P({...l,numeroDomicilio:o.target.value}),disabled:s,error:n.numeroDomicilio}),e.jsx(X,{label:"Calle secundaria *",value:l.calleSecundaria,onChange:o=>P({...l,calleSecundaria:o.target.value}),disabled:s,error:n.calleSecundaria}),e.jsx(X,{label:"Referencia *",value:l.referenciaDomicilio,onChange:o=>P({...l,referenciaDomicilio:o.target.value}),disabled:s,error:n.referenciaDomicilio}),e.jsx(X,{label:"Tiempo de residencia (años) *",type:"number",value:l.tiempoResidencia,onChange:o=>P({...l,tiempoResidencia:o.target.value}),disabled:s,error:n.tiempoResidencia}),e.jsx(X,{label:"Sector / Barrio *",value:l.sectorBarrio,onChange:o=>P({...l,sectorBarrio:o.target.value}),disabled:s,error:n.sectorBarrio})]})}),e.jsx(Y,{children:e.jsxs(_,{className:"p-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(We,{label:"Residente otro país",checked:l.residenteOtroPais,onChange:o=>P({...l,residenteOtroPais:o,numeroIdentificacionOtroPais:o?l.numeroIdentificacionOtroPais:""}),disabled:s}),l.residenteOtroPais&&e.jsx(X,{label:"Número de identificación (Otro País)",value:l.numeroIdentificacionOtroPais,onChange:o=>P({...l,numeroIdentificacionOtroPais:o.target.value}),disabled:s}),e.jsx(We,{label:"Contribuyente EEUU",checked:l.contribuyenteEEUU,onChange:o=>P({...l,contribuyenteEEUU:o,numeroIdentificacionEEUU:o?l.numeroIdentificacionEEUU:""}),disabled:s}),l.contribuyenteEEUU&&e.jsx(X,{label:"Número de Identificación(EE.UU.)",value:l.numeroIdentificacionEEUU,onChange:o=>P({...l,numeroIdentificacionEEUU:o.target.value}),disabled:s})]})})]})]})}function X({label:a,value:i,onChange:u,type:b="text",disabled:S,error:s}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs($,{className:"text-sm font-medium text-gray-700 flex items-center gap-1",children:[a,s&&e.jsx("span",{className:"text-red-600 text-xs italic",children:s})]}),e.jsx(q,{placeholder:"---",type:b,value:i,onChange:u,disabled:S,"aria-invalid":!!s})]})}function We({label:a,checked:i,onChange:u,disabled:b}){return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ue,{checked:i,onCheckedChange:u,disabled:b,className:`
            peer
            inline-flex
            h-6 w-11 shrink-0
            cursor-pointer
            items-center
            rounded-full
            border
            border-gray-700
            transition-colors
            duration-200
            ease-in-out
            ${i?"bg-primary":"bg-gray-300"}
          `}),e.jsx("span",{className:`
            pointer-events-none
            absolute
            left-0.5 top-0.5
            h-5 w-5
            transform
            rounded-full
            bg-white
            shadow
            transition-transform
            duration-200
            ease-in-out
            ${i?"translate-x-5":"translate-x-0"}
          `})]}),e.jsx($,{className:"text-sm font-medium text-gray-700",children:a})]})}function pe({label:a,children:i}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsx($,{className:"text-sm font-medium text-gray-700",children:a}),i]})}function vi({id:a}){const[i,u]=c.useState(!0),[b,S]=c.useState(null),[s,E]=c.useState({idBanco:"",bancoNombre:"",idTipoCuenta:"",nombreTipoCuenta:"",numeroCuenta:""}),[l,P]=c.useState([]),[v,I]=c.useState([]),[y,g]=c.useState(!1),[T,x]=c.useState(""),[D,j]=c.useState({});c.useEffect(()=>{(async()=>{u(!0);try{const w=(await ce(a)).data[0],o=await ja(),r=await va();S(w),g(w.faseProceso!==1),E({idBanco:w.banco.idBanco??"",bancoNombre:w.banco.bancoNombre??"",idTipoCuenta:w.banco.idTipoCuenta??"",nombreTipoCuenta:w.banco.nombreTipoCuenta??"",numeroCuenta:w.banco.numeroCuenta??""}),P(o.map(N=>({id:String(N.idBanco),nombre:N.bancoNombre}))),I(r.map(N=>({id:String(N.idTipoCuenta),nombre:N.nombre})))}catch(f){h.error("Error al cargar datos de banco: "+f.message)}finally{u(!1)}})()},[a]);const n=()=>{const m={};return s.idBanco||(m.idBanco="Banco es obligatorio"),s.idTipoCuenta||(m.idTipoCuenta="Tipo de cuenta es obligatorio"),(!s.numeroCuenta||s.numeroCuenta.trim()==="")&&(m.numeroCuenta="Número de cuenta es obligatorio"),j(m),Object.keys(m).length===0},t=async()=>{if(!(!b||y)){if(!n()){h.error("Por favor complete los campos obligatorios.");return}u(!0);try{const m={...b,identificacion:te(b.identificacion),banco:s};(await re(a,m)).success?h.success("Datos de banco actualizados."):h.error("Error al actualizar datos de banco.")}catch(m){h.error("Error al guardar: "+m.message)}finally{u(!1)}}},F=l.filter(m=>m.nombre.toLowerCase().includes(T.toLowerCase()));return e.jsxs("div",{className:"space-y-6 p-6 relative",children:[e.jsx(se,{visible:i,message:"Cargando datos de banco..."}),!i&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Datos bancarios del cliente"}),y&&e.jsx("div",{className:"w-full flex items-center px-6 py-2 mb-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-800 font-semibold",children:e.jsx("span",{children:"No se permite editar datos bancarios en esta fase."})}),e.jsx(Z,{onClick:t,disabled:i||y,className:"text-white",children:"Guardar datos"}),e.jsx(Y,{children:e.jsxs(_,{className:"p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs($,{className:"text-sm font-medium text-gray-700",children:["Banco ",e.jsx("span",{className:"text-red-600",children:"*"})]}),e.jsx(q,{placeholder:"Buscar banco...",value:T,onChange:m=>x(m.target.value),disabled:y,className:"mb-2"}),e.jsxs(O,{value:String(s.idBanco),onValueChange:m=>E({...s,idBanco:m}),disabled:y,className:D.idBanco?"border-red-600":"",children:[e.jsx(G,{className:`bg-white border ${D.idBanco?"border-red-600":"border-gray-700"}`,children:e.jsx(L,{placeholder:"Seleccione un banco"})}),e.jsx(V,{className:"bg-white border border-gray-200 shadow-xl z-[9999] max-h-60 overflow-auto",children:F.length>0?F.map(m=>e.jsx(k,{value:m.id,children:m.nombre},m.id)):e.jsx("div",{className:"p-2 text-center text-gray-500",children:"No se encontraron bancos"})})]}),D.idBanco&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:D.idBanco})]}),e.jsx(qa,{label:"Tipo de Cuenta *",options:v,value:s.idTipoCuenta,onChange:m=>E({...s,idTipoCuenta:m}),disabled:y,error:D.idTipoCuenta}),e.jsx(Ja,{label:"Número de Cuenta *",value:s.numeroCuenta,onChange:m=>E({...s,numeroCuenta:m.target.value}),disabled:y,error:D.numeroCuenta})]})})]})]})}function Ja({label:a,value:i,onChange:u,type:b="text",disabled:S,error:s}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs($,{className:"text-sm font-medium text-gray-700",children:[a,s&&e.jsx("span",{className:"text-red-600 ml-1 text-sm",children:"*"})]}),e.jsx(q,{placeholder:"---",type:b,value:i,onChange:u,disabled:S,className:s?"border-red-600":""}),s&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:s})]})}function qa({label:a,options:i,value:u,onChange:b,disabled:S,error:s}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs($,{className:"text-sm font-medium text-gray-700",children:[a,s&&e.jsx("span",{className:"text-red-600 ml-1 text-sm",children:"*"})]}),e.jsxs(O,{value:String(u),onValueChange:b,disabled:S,children:[e.jsx(G,{className:`bg-white border ${s?"border-red-600":"border-gray-700"}`,children:e.jsx(L,{placeholder:"Seleccione una opción"})}),e.jsx(V,{className:"bg-white border border-gray-200 shadow-xl z-[9999] max-h-60 overflow-auto",children:i.map(E=>e.jsx(k,{value:E.id,children:E.nombre},E.id))})]}),s&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:s})]})}const Ae=()=>{var i;return{"Content-Type":"application/json",Authorization:`Bearer ${(i=JSON.parse(localStorage.getItem("user")))==null?void 0:i.token}`}},Re=async a=>{if(!a.ok){const i=await a.text();throw new Error(i||"Error en la solicitud")}return await a.json()},Ma=async a=>{const i=await fetch(`${U}/vista/beneficiario/filtrar?por=idSolicitudInversion&id=${a}`,{headers:Ae()});return Re(i)},Ha=async a=>{const i=await fetch(`${U}/beneficiario`,{method:"POST",headers:Ae(),body:JSON.stringify(a)});return Re(i)},Ya=async(a,i)=>{const u=await fetch(`${U}/beneficiario/${a}`,{method:"PUT",headers:Ae(),body:JSON.stringify(i)});return Re(u)},_a=async a=>{const i=await fetch(`${U}/beneficiario/${a}`,{method:"DELETE",headers:Ae()});return Re(i)};function yi(){var o;const{id:a}=we(),{user:i}=Xe(),[u,b]=c.useState([]),[S,s]=c.useState(!1),[E,l]=c.useState(!1),[P,v]=c.useState([]),[I,y]=c.useState(!0),[g,T]=c.useState(!1),[x,D]=c.useState(!1),[j,n]=c.useState({idSolicitudInversion:Number(a),nombre:"",idTipoDocumento:"",numeroDocumento:"",correoElectronico:"",telefono:"",direccion:"",porcentajeBeneficio:"",fechaCreacion:new Date().toISOString(),idUsuarioPropietario:i.idUsuario});c.useEffect(()=>{(async()=>{try{const C=(await ce(a)).data[0];D(C.faseProceso!==1)}catch{D(!1)}})()},[a]);const t=async()=>{y(!0);try{const r=await Ma(a);b(r)}catch(r){h.error("Error al cargar beneficiarios"+(r.message||""))}finally{y(!1)}};c.useEffect(()=>{(async()=>{try{const N=await Ze();v(N)}catch(N){h.error("Error al cargar tipos de identificación"+(N.message||""))}})(),t()},[]);const F=()=>{l(!1),n({idSolicitudInversion:Number(a),nombre:"",idTipoDocumento:"",numeroDocumento:"",correoElectronico:"",telefono:"",direccion:"",porcentajeBeneficio:"",fechaCreacion:new Date().toISOString(),idUsuarioPropietario:i.idUsuario}),s(!0)},m=r=>{l(!0),n({idBeneficiario:r.idBeneficiario,idSolicitudInversion:Number(a),nombre:r.nombre,idTipoDocumento:r.idTipoDocumento,numeroDocumento:r.numeroDocumento,correoElectronico:r.correoElectronico,telefono:r.telefono,direccion:r.direccion,porcentajeBeneficio:r.porcentajeBeneficio,fechaCreacion:r.fechaCreacion,idUsuarioPropietario:i.idUsuario}),s(!0)},f=async r=>{if(!x&&window.confirm(`¿Deseas eliminar a "${r.nombre}"?`)){y(!0);try{await _a(r.idBeneficiario),h.success("Beneficiario eliminado"),t()}catch(N){h.error("Error al eliminar beneficiario"+(N.message||""))}finally{y(!1)}}},w=[{key:"idBeneficiario",label:"",render:r=>e.jsx("span",{title:`ID Beneficiario: ${r}`,className:"flex justify-center cursor-default text-gray-600 hover:text-gray-900",children:e.jsx(ea,{size:18})})},{key:"nombre",label:"Nombre"},{key:"idTipoDocumento",label:"Tipo Documento"},{key:"numeroDocumento",label:"Número Documento"},{key:"correoElectronico",label:"Correo"},{key:"telefono",label:"Teléfono"},{key:"direccion",label:"Dirección"},{key:"porcentajeBeneficio",label:"Porcentaje (%)"},{key:"fechaCreacion",label:"Fecha de Creación"}];return e.jsxs("div",{className:"space-y-6 p-6 relative",children:[e.jsx(se,{visible:I||g,message:g?"Guardando...":"Cargando beneficiarios..."}),!I&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Beneficiarios"}),x&&e.jsx("div",{className:"w-full flex items-center px-6 py-2 mb-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-800 font-semibold",children:e.jsx("span",{children:"No se permite editar beneficiarios en esta fase."})}),e.jsx(Y,{children:e.jsx(_,{className:"p-6 space-y-4",children:e.jsx(Be,{columns:w,data:u,mostrarEditar:!x,mostrarAgregarNuevo:!x,mostrarEliminar:!x,onAgregarNuevoClick:F,onEditarClick:m,onEliminarClick:f})})})]}),e.jsx(ze,{open:S,onOpenChange:s,children:e.jsxs(Oe,{children:[e.jsx(aa,{children:e.jsx(ia,{children:E?"Editar beneficiario":"Agregar beneficiario"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(de,{label:"Nombre",children:e.jsx(q,{placeholder:"---",value:j.nombre,onChange:r=>n({...j,nombre:r.target.value}),disabled:x})}),e.jsx(de,{label:"Tipo Documento",children:e.jsxs(O,{value:((o=j.idTipoDocumento)==null?void 0:o.toString())||"",onValueChange:r=>n({...j,idTipoDocumento:Number(r)}),disabled:x,children:[e.jsx(G,{className:"bg-white border border-gray-300",children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsx(V,{className:"bg-white",children:P.map(r=>e.jsx(k,{value:r.idTipoIdentificacion.toString(),children:r.tipo},r.idTipoIdentificacion))})]})}),e.jsx(de,{label:"Número Documento",children:e.jsx(q,{placeholder:"---",value:j.numeroDocumento,onChange:r=>n({...j,numeroDocumento:r.target.value}),disabled:x})}),e.jsx(de,{label:"Correo electrónico",children:e.jsx(q,{placeholder:"---",type:"email",value:j.correoElectronico,onChange:r=>n({...j,correoElectronico:r.target.value}),disabled:x})}),e.jsx(de,{label:"Teléfono",children:e.jsx(q,{placeholder:"---",value:j.telefono,onChange:r=>n({...j,telefono:r.target.value}),disabled:x})}),e.jsx(de,{label:"Dirección",children:e.jsx(q,{placeholder:"---",value:j.direccion,onChange:r=>n({...j,direccion:r.target.value}),disabled:x})}),e.jsx(de,{label:"Porcentaje de beneficio",children:e.jsx(q,{type:"number",placeholder:"---",value:j.porcentajeBeneficio,onChange:r=>n({...j,porcentajeBeneficio:r.target.value}),disabled:x})})]}),e.jsx(Ge,{className:"pt-4",children:e.jsx(Z,{disabled:g||x,onClick:async()=>{const{nombre:r,idTipoDocumento:N,numeroDocumento:C,correoElectronico:B,telefono:M,direccion:p,porcentajeBeneficio:z}=j;if(!r.trim()||!N||!C.trim()||!B.trim()||!M.trim()||!p.trim()||!z){h.error("Todos los campos son obligatorios");return}T(!0);try{E?(await Ya(j.idBeneficiario,j),h.success("Beneficiario actualizado")):(await Ha(j),h.success("Beneficiario creado")),t(),s(!1),l(!1),n({idSolicitudInversion:Number(a),nombre:"",idTipoDocumento:"",numeroDocumento:"",correoElectronico:"",telefono:"",direccion:"",porcentajeBeneficio:"",fechaCreacion:new Date().toISOString(),idUsuarioPropietario:i.idUsuario})}catch(A){h.error("No se pudo guardar el beneficiario"+(A.message||""))}finally{T(!1)}},children:E?"Actualizar":"Crear"})})]})})]})}function de({label:a,children:i}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsx($,{className:"text-sm font-medium text-gray-700",children:a}),i]})}const Ka=()=>{var i;return{"Content-Type":"application/json",Authorization:`Bearer ${(i=JSON.parse(localStorage.getItem("user")))==null?void 0:i.token}`}},Qa=async a=>{if(!a.ok){const i=await a.text();throw new Error(i||"Error en la solicitud")}return a.json()},Wa=async()=>{const a=await fetch(`${U}/ContinuarSolicitud`,{headers:Ka()});return Qa(a)};function Ci({id:a}){const[i,u]=c.useState(!0),[b,S]=c.useState(!1),[s,E]=c.useState(null),[l,P]=c.useState([]),[v,I]=c.useState({numeroContrato:"",idContinuarSolicitud:"",nombreContinuarSolicitud:"",motivoFinalizacion:"",observacionFinalizacion:"",confirmar:!1}),[y,g]=c.useState(!1),[T,x]=c.useState(""),[D,j]=c.useState(!1);c.useEffect(()=>{(async()=>{try{const o=(await ce(a)).data[0];E(o),j(o.faseProceso!==1),I({numeroContrato:o.finalizacion.numeroContrato??"",idContinuarSolicitud:o.finalizacion.idContinuarSolicitud??"",nombreContinuarSolicitud:o.finalizacion.nombreContinuarSolicitud??"",motivoFinalizacion:o.finalizacion.motivoFinalizacion??"",observacionFinalizacion:o.finalizacion.observacionFinalizacion??"",confirmar:o.finalizacion.confirmar??!1})}catch(w){h.error("Error al cargar finalización: "+w.message)}finally{u(!1)}})()},[a]),c.useEffect(()=>{(async()=>{try{const w=await Wa();P(Array.isArray(w)?w:[])}catch(w){h.error("Error al cargar catálogo: "+w.message)}})()},[]);const n=async()=>{if(!v.numeroContrato){g(!0);return}if(s){u(!0);try{const f={...s,identificacion:te(s.identificacion),finalizacion:v};(await re(a,f)).success?h.success("Finalización actualizada."):h.error("Error al actualizar.")}catch(f){h.error("Error al guardar: "+f.message)}finally{u(!1)}}},t=async()=>{var f;if(!(s!=null&&s.idSolicitudInversion)||!((f=s==null?void 0:s.proyeccion)!=null&&f.idProyeccionSeleccionada)){h.error("No se puede generar número de contrato. Verifica que exista una proyección seleccionada.");return}x("Generando número de contrato..."),S(!0);try{const w=await fa(s.idSolicitudInversion,s.proyeccion.idProyeccionSeleccionada);w&&w.numeroContrato?(I(o=>({...o,numeroContrato:w.numeroContrato})),h.success("Número de contrato generado.")):h.error("No se pudo generar el número de contrato.")}catch(w){h.error(w.message||"Error al generar número de contrato.")}finally{S(!1),x("")}},F=async()=>{if(!(D||b||i)){if(!v.numeroContrato){h.error("Debe generar un número de contrato antes de confirmar.");return}S(!0),x("Guardando datos de finalización...");try{const f={...s,identificacion:te(s.identificacion),finalizacion:v};if(!(await re(a,f)).success)throw new Error("No se pudo guardar la finalización antes de continuar");x("Procesando acción..."),v.idContinuarSolicitud===1?(await ya(a),h.success("Datos guardados y tareas generadas correctamente.")):h.success("Datos guardados correctamente."),I(o=>({...o,confirmar:!0}))}catch(f){h.error("Error al confirmar finalización: "+(f.message||f))}finally{S(!1),x("")}}},m=D||!v.numeroContrato||v.confirmar||b||i;return i?e.jsx(se,{visible:!0,message:"Cargando finalización..."}):e.jsxs("div",{className:"space-y-6 p-6 relative",children:[e.jsx(se,{visible:b,message:T}),D&&e.jsx("div",{className:"w-full flex items-center px-6 py-2 mb-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-800 font-semibold",children:e.jsx("span",{children:"No se permite editar la finalización en esta fase."})}),e.jsx(je,{open:y,onOpenChange:g,children:e.jsxs(ve,{className:"bg-white border border-gray-200 rounded-xl shadow-xl",children:[e.jsxs(ye,{children:[e.jsx(Ce,{className:"text-violet-700 font-semibold",children:"Debes generar el número de contrato primero"}),e.jsx("div",{className:"text-gray-700 mt-2",children:"Antes de continuar, debes generar el número de contrato."})]}),e.jsx(Ne,{children:e.jsx(Se,{className:"border border-gray-300 bg-white hover:bg-gray-50",children:"Cerrar"})})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(Z,{onClick:n,className:"bg-primary text-white hover:bg-primary/80 flex items-center gap-2",disabled:D||i||b,children:[e.jsx(da,{className:"w-4 h-4"})," Guardar"]})}),e.jsx("h2",{className:"text-xl font-semibold",children:"Finalización"}),e.jsx(Y,{children:e.jsxs(_,{className:"p-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx($e,{label:"Número de contrato",value:v.numeroContrato,onChange:()=>{},disabled:!0}),e.jsx(Z,{onClick:t,className:"h-10",variant:"muted",disabled:D||!!v.numeroContrato.trim()||v.confirmar||b,children:"Generar número de contrato"})]}),e.jsx(Za,{label:"Acción",children:e.jsxs(O,{disabled:m,value:String(v.idContinuarSolicitud),onValueChange:f=>{const w=parseInt(f,10),o=l.find(r=>r.idContinuarSolicitud===w);I({...v,idContinuarSolicitud:w,nombreContinuarSolicitud:(o==null?void 0:o.nombre)??""})},children:[e.jsx(G,{className:"text-sm border border-black",children:e.jsx(L,{placeholder:"Seleccione una acción"})}),e.jsx(V,{className:"bg-white",children:l.map(f=>e.jsx(k,{value:String(f.idContinuarSolicitud),children:f.nombre},f.idContinuarSolicitud))})]})}),v.idContinuarSolicitud===2&&e.jsxs(e.Fragment,{children:[e.jsx($e,{label:"Motivo de finalización",value:v.motivoFinalizacion,onChange:f=>I({...v,motivoFinalizacion:f.target.value}),disabled:m}),e.jsx($e,{label:"Observación de finalización",value:v.observacionFinalizacion,onChange:f=>I({...v,observacionFinalizacion:f.target.value}),disabled:m})]}),(v.idContinuarSolicitud===1||v.idContinuarSolicitud===2)&&e.jsx(Xa,{label:"Confirmar",checked:v.confirmar,idContinuar:v.idContinuarSolicitud,onConfirm:F,className:"border border-gray-300 p-4 rounded-md",disabled:m})]})})]})}function $e({label:a,value:i,onChange:u,type:b="text",disabled:S}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsx($,{className:"text-sm font-medium text-gray-700",children:a}),e.jsx(q,{placeholder:"---",type:b,value:i,onChange:u,disabled:S})]})}function Xa({label:a,checked:i,onConfirm:u,idContinuar:b,disabled:S}){const[s,E]=c.useState(!1),l=()=>{E(!1),S||u()};return i?e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ue,{checked:!0,disabled:!0,className:"bg-violet-600 border-violet-700 opacity-90 !cursor-not-allowed",style:{opacity:1}}),e.jsx($,{className:"text-sm font-medium text-gray-700",children:a})]}):S?e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ue,{checked:!1,disabled:!0,className:"bg-black border-black-400 opacity-80 !cursor-not-allowed",style:{opacity:1}}),e.jsx($,{className:"text-sm font-medium text-gray-700",children:a})]}):e.jsxs(je,{open:s,onOpenChange:E,children:[e.jsx(pa,{asChild:!0,children:e.jsxs("div",{className:"flex items-center gap-4 cursor-pointer",children:[e.jsx(ue,{checked:!1,onCheckedChange:()=>E(!0)}),e.jsx($,{className:"text-sm font-medium text-gray-700",children:a})]})}),e.jsxs(ve,{className:"bg-white text-black border border-gray-300",children:[e.jsx(ye,{children:e.jsx(Ce,{className:"text-violet-700 font-semibold",children:"¿Estás seguro de terminar la solicitud?"})}),e.jsxs(Ne,{children:[e.jsx(Se,{children:"Cancelar"}),e.jsxs(Ue,{onClick:l,children:["Sí, ",b===1?"crear tareas":"finalizar"]})]})]})]})}function Za({label:a,children:i}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsx($,{className:"text-sm font-medium text-gray-700",children:a}),i]})}export{pi as A,vi as B,ji as C,xi as D,Ci as F,hi as I,bi as P,yi as a};
