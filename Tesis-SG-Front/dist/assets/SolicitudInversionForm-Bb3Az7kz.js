import{c as A,r as m,t as l,j as a,G as B,I as c,B as b,l as G,L as O}from"./index-ABbIRX4x.js";import{S as v,a as C,b as N,c as y,d as S}from"./select-C75wXMdb.js";import{v as k,a as F,c as K}from"./SolicitudService-BRPNL4PC.js";import{g as U}from"./TipoClienteService-BAK64bBK.js";import{g as H}from"./TipoIdentificacionService-BJmrDHaB.js";import"./index-CFqNEq9z.js";const J=[{id:1,label:"Continuar con la solicitud"},{id:0,label:"Rechazar solicitud"}];function ee({idProspecto:h=null,idCliente:f=null,onClose:x,onSaved:g}){const{user:j}=A(),[D,I]=m.useState({tipoCliente:[],tipoDocumento:[]}),[e,E]=m.useState({tipoSolicitud:1,tipoCliente:"",tipoDocumento:"",numeroDocumento:"",nombres:"",apellidoPaterno:"",apellidoMaterno:"",validar:!1,equifax:"",obsEquifax:"",listasControl:"",obsListasControl:"",continuar:1}),[p,q]=m.useState(!1),[s,L]=m.useState(!1),[n,w]=m.useState(!1);m.useEffect(()=>{(async()=>{try{const[o,t]=await Promise.all([U(),H()]);I({tipoCliente:o,tipoDocumento:t})}catch(o){l.error("No se pudieron cargar los catálogos. "+(o.message||o))}})()},[]);const i=(o,t)=>E(u=>({...u,[o]:t})),R=async()=>{if(!(s||n)){if(!e.tipoCliente||!e.tipoDocumento||!e.numeroDocumento.trim()||!e.nombres.trim()||!e.apellidoPaterno.trim()||!e.apellidoMaterno.trim())return l.error("Por favor llena todos los campos antes de validar."),!1;L(!0),l.info("Validando información en Equifax y LDS...");try{const o=await k(e.numeroDocumento);if(o.success){const d=o.resultado;i("equifax",d.error?"Error":d.resultado?"Paso":"Rechazado"),i("obsEquifax",d.observacion||"Sin observación")}else i("equifax","Error"),i("obsEquifax","Error en validación Equifax");const t=(e.nombres??"").trim().split(" "),u=t[0]||"",M=t.slice(1).join(" ")||"",P=await F({identificacion:e.numeroDocumento,primerNombre:u,segundoNombre:M,primerApellido:e.apellidoPaterno,segundoApellido:e.apellidoMaterno});if(P.success){const d=P.resultado;i("listasControl",d.error?"Error":d.coincidencia?"Rechazado":"Paso"),i("obsListasControl",d.mensaje||"Sin observación")}else i("listasControl","Error"),i("obsListasControl","Error en validación LDS");return w(!0),i("validar",!0),l.success("Validación completada."),!0}catch{return l.error("Ocurrió un error durante la validación."),!1}finally{L(!1)}}},T=()=>{w(!1),E(o=>({...o,validar:!1}))},V=async o=>{if(o.preventDefault(),!e.tipoCliente||!e.tipoDocumento||!e.numeroDocumento.trim()||!e.nombres.trim()||!e.apellidoPaterno.trim()||!e.apellidoMaterno.trim()){l.error("Todos los campos son obligatorios.");return}if(!e.validar){l.error("Debes validar antes de guardar la solicitud.");return}if(e.equifax==="Rechazado"||e.listasControl==="Rechazado"){l.error("No puedes guardar una solicitud rechazada por validación.");return}if(Number(e.continuar)!==1){l.error("Solo puedes guardar si seleccionas 'Continuar con la solicitud'.");return}const t={idUsuarioPropietario:(j==null?void 0:j.id)??null,idProspecto:h??null,idCliente:f??null,identificacion:{tipoSolicitud:1,tipoCliente:Number(e.tipoCliente),tipoDocumento:Number(e.tipoDocumento),numeroDocumento:e.numeroDocumento.trim(),nombres:e.nombres.trim(),apellidoPaterno:e.apellidoPaterno.trim(),apellidoMaterno:e.apellidoMaterno.trim(),validar:e.validar,equifax:e.equifax,obsEquifax:e.obsEquifax,listasControl:e.listasControl,obsListasControl:e.obsListasControl,continuar:Number(e.continuar)}};console.log("Payload enviado:",t),q(!0);try{await K(t),l.success("Solicitud de inversión creada correctamente."),g==null||g(),x==null||x()}catch(u){l.error("Error al crear solicitud: "+(u.message??u))}finally{q(!1)}},z=e.tipoCliente&&e.tipoDocumento&&e.numeroDocumento.trim()&&e.nombres.trim()&&e.apellidoPaterno.trim()&&e.apellidoMaterno.trim()&&!e.validar;return a.jsxs("div",{className:"relative px-2 py-3 md:px-7 md:py-7",children:[a.jsx(B,{visible:p||s,message:p?"Guardando solicitud...":s?"Validando...":""}),a.jsxs("form",{onSubmit:V,className:"space-y-8 max-w-xl mx-auto",autoComplete:"off",children:[a.jsxs("section",{className:"bg-white rounded-2xl border border-gray-200 px-7 py-5 flex flex-col gap-4 shadow-lg transition-colors",children:[a.jsx("h3",{className:"font-semibold text-lg text-violet-700 mb-3 border-b pb-2",children:"Nueva Solicitud de Inversión"}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5",children:[a.jsx(r,{label:"Tipo de Solicitud",children:a.jsx(c,{value:"Nueva",disabled:!0,className:"bg-gray-100 font-semibold",placeholder:"Nueva"})}),a.jsx(r,{label:"Tipo de Cliente",children:a.jsxs(v,{required:!0,value:e.tipoCliente,disabled:n,onValueChange:o=>i("tipoCliente",o),children:[a.jsx(C,{children:a.jsx(N,{placeholder:"Seleccionar tipo"})}),a.jsx(y,{className:"bg-white",children:D.tipoCliente.map(o=>a.jsx(S,{value:o.idTipoCliente.toString(),children:o.nombreTipoCliente},o.idTipoCliente))})]})}),a.jsx(r,{label:"Tipo de Documento",children:a.jsxs(v,{required:!0,value:e.tipoDocumento,disabled:n,onValueChange:o=>i("tipoDocumento",o),children:[a.jsx(C,{children:a.jsx(N,{placeholder:"Seleccionar tipo"})}),a.jsx(y,{className:"bg-white",children:D.tipoDocumento.map(o=>a.jsx(S,{value:o.idTipoIdentificacion.toString(),children:o.tipo},o.idTipoIdentificacion))})]})}),a.jsx(r,{label:"Número de Identificación",children:a.jsx(c,{value:e.numeroDocumento,onChange:o=>i("numeroDocumento",o.target.value),maxLength:20,required:!0,disabled:n,placeholder:"Ej: 1004177448"})}),a.jsx(r,{label:"Nombres",children:a.jsx(c,{value:e.nombres,onChange:o=>i("nombres",o.target.value),maxLength:60,required:!0,disabled:n,placeholder:"Ej: Kevin Rodrigo"})}),a.jsx(r,{label:"Apellido Paterno",children:a.jsx(c,{value:e.apellidoPaterno,onChange:o=>i("apellidoPaterno",o.target.value),maxLength:30,required:!0,disabled:n,placeholder:"Ej: Rosero"})}),a.jsx(r,{label:"Apellido Materno",children:a.jsx(c,{value:e.apellidoMaterno,onChange:o=>i("apellidoMaterno",o.target.value),maxLength:30,disabled:n,placeholder:"Ej: Insuasti"})})]}),z&&a.jsx("div",{className:"flex justify-end mt-2",children:a.jsxs(b,{type:"button",className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2",onClick:R,disabled:s||n,children:[s&&a.jsx(G,{className:"animate-spin w-4 h-4 mr-2"}),"Validar Información"]})}),e.validar&&a.jsx("div",{className:"mt-4 border-t pt-4",children:a.jsxs("div",{className:"flex flex-col gap-3 w-full",children:[a.jsx(r,{label:"Identidad (Equifax)",children:a.jsx(c,{value:e.equifax,disabled:!0})}),a.jsx(r,{label:"Observación Equifax",children:a.jsx("textarea",{rows:2,className:"w-full rounded-md border border-gray-300 p-2 bg-gray-50 text-sm",value:e.obsEquifax,disabled:!0})}),a.jsx(r,{label:"Listas de Control (LDS)",children:a.jsx(c,{value:e.listasControl,disabled:!0})}),a.jsx(r,{label:"Observación LDS",children:a.jsx("textarea",{rows:2,className:"w-full rounded-md border border-gray-300 p-2 bg-gray-50 text-sm",value:e.obsListasControl,disabled:!0})}),a.jsx(r,{label:"Continuar",children:a.jsxs(v,{value:String(e.continuar),disabled:e.equifax==="Rechazado"||e.listasControl==="Rechazado",onValueChange:o=>i("continuar",o),children:[a.jsx(C,{children:a.jsx(N,{placeholder:"Continuar"})}),a.jsx(y,{className:"bg-white",children:J.map(o=>a.jsx(S,{value:String(o.id),children:o.label},o.id))})]})}),a.jsx("div",{className:"flex justify-end mt-2",children:a.jsx(b,{type:"button",variant:"outline",className:"px-5",onClick:T,disabled:p||s,children:"Editar datos"})})]})})]}),a.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[a.jsx(b,{type:"button",variant:"outline",onClick:x,className:"px-6 py-2",disabled:p||s,children:"Cancelar"}),a.jsx(b,{type:"submit",className:"bg-violet-600 hover:bg-violet-700 text-white px-6 py-2",disabled:p||s||!e.validar||Number(e.continuar)!==1||e.equifax==="Rechazado"||e.listasControl==="Rechazado",children:"Guardar Solicitud"})]})]})]})}function r({label:h,children:f}){return a.jsxs("div",{className:"space-y-1.5",children:[a.jsx(O,{className:"font-medium text-gray-700 text-sm",children:h}),f]})}export{ee as default};
