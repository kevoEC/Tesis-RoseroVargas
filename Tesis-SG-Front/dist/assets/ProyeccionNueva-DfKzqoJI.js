import{f as te,v as ie,r as n,j as e,G as se,C as L,a as M,L as w,E as le,B as S,I as ne}from"./index-ABbIRX4x.js";import{g as oe,c as ce}from"./ProyeccionService-PEcHVMkt.js";import{S as de,a as me,b as ue,c as pe,d as ge}from"./select-C75wXMdb.js";import{D as xe,a as he,b as fe,c as be,e as je}from"./jspdf.plugin.autotable-CZR7NrjE.js";import{T as ye}from"./TablaCustom2-DS7_i3Ng.js";import"./index-CFqNEq9z.js";function o(i){return`$${Number(i).toLocaleString("es-EC",{minimumFractionDigits:2})}`}function A(i){return i?new Date(i).toLocaleDateString("es-EC",{day:"2-digit",month:"2-digit",year:"numeric"}):""}function ve({content:i,children:t}){return e.jsxs("div",{className:"relative group inline-block",children:[t,e.jsxs("div",{className:"absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 whitespace-normal w-56 bg-black text-white text-xs rounded p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50",children:[i,e.jsx("svg",{className:"absolute top-full left-1/2 -translate-x-1/2 fill-black",width:"16",height:"8",viewBox:"0 0 16 8",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M0 0L8 8L16 0H0Z"})})]})]})}function Oe(){const{id:i}=te(),{notify:t,user:d}=ie(),[r,p]=n.useState({tipoSolicitud:"1",idProducto:"1",capital:"",plazo:"",fechaInicial:"",idOrigenCapital:"",idSolicitudInversion:parseInt(i),costeOperativo:0}),[g,h]=n.useState([]),[l,q]=n.useState(null),[m,B]=n.useState(!1),[G,y]=n.useState(!1),[z,U]=n.useState(null),[O,f]=n.useState(null),[E,b]=n.useState(!1),[$,v]=n.useState(!1),N=parseFloat(r.capital)>=1e3,D=N,F=D&&r.idOrigenCapital!=="",H=F&&r.plazo!=="",Y=["7","13","25","37"],Z=["6","12","24","36"],R=r.idOrigenCapital==="2"?Z:Y,J={1:"Renta Fija: El pago del rendimiento junto al capital se realiza al final del plazo seleccionado. Ideal para inversiones con rendimiento acumulado hasta vencimiento.",2:"Renta Periódica Mensual: El pago de la rentabilidad se realiza mensualmente, proporcionando flujo constante de ingresos.",3:"Renta Periódica Bimensual: El pago de la rentabilidad se efectúa cada dos meses, equilibrando periodicidad y acumulación.",4:"Renta Periódica Trimestral: El pago de la rentabilidad se efectúa cada tres meses, permitiendo mayor acumulación entre pagos.",5:"Renta Periódica Semestral: El pago de la rentabilidad se realiza cada seis meses, ideal para inversiones con pagos menos frecuentes."},j=(a,s)=>{if(["capital","idOrigenCapital","plazo"].includes(a)&&(f(null),b(!1)),a==="capital"){(s===""||/^\d*\.?\d*$/.test(s))&&p(c=>({...c,[a]:s}));return}p(c=>({...c,[a]:s}))},T=a=>{if(!a)return!1;const[s,c,C]=a.split("-"),u=parseInt(s,10),ae=parseInt(c,10),k=parseInt(C,10);if(![1,10,20].includes(k))return!1;const P=new Date,re=new Date(Date.UTC(P.getFullYear(),P.getMonth(),P.getDate()));return!(new Date(Date.UTC(u,ae-1,k))<re)},K=()=>N?!D||r.idOrigenCapital===""?(t.error("Selecciona el origen del capital."),!1):!F||r.plazo===""?(t.error("Selecciona el plazo."),!1):!H||r.fechaInicial===""?(t.error("Selecciona una fecha inicial válida (01, 10 o 20 y no fechas pasadas)."),!1):T(r.fechaInicial)?!0:(t.error("Fecha inicial no válida. Solo 01, 10 o 20, y no fechas pasadas permitidas."),!1):(t.error("El capital debe ser al menos $1000."),!1),Q=async()=>{if(K()){v(!0);try{const a={...r,idProducto:parseInt(r.idProducto),idOrigenCapital:parseInt(r.idOrigenCapital),plazo:parseInt(r.plazo),capital:parseFloat(r.capital)},c=(await oe(a.idProducto)).filter(u=>u.idOrigen===a.idOrigenCapital&&u.plazo===a.plazo);if(c.length===0){t.error("No hay configuraciones con ese origen y plazo."),b(!1),f(null);return}const C=c.find(u=>a.capital>=u.montoMinimo&&a.capital<=u.montoMaximo);if(!C){t.error("El capital ingresado no está en un rango válido para ese origen y plazo."),b(!1),f(null);return}t.success("Tasa encontrada correctamente."),f(C.taza),b(!0)}catch(a){console.error("Error al consultar tasa:",a),t.error("Error al consultar la tasa."),b(!1),f(null)}finally{v(!1)}}},W=async()=>{if(!E){t.error("Debes consultar y validar la tasa antes de generar.");return}v(!0);try{const a={...r,idProducto:parseInt(r.idProducto),idUsuario:(d==null?void 0:d.idUsuario)??0,idOrigenCapital:parseInt(r.idOrigenCapital),tipoSolicitud:parseInt(r.tipoSolicitud)},s=await ce(a);s.success?(q(s.proyeccion),h(s.cronograma),t.success("Cronograma generado correctamente."),B(!0)):t.error("No se pudo generar la proyección.")}catch(a){t.error("Error al generar proyección."),console.error("Error al generar proyección:",a)}finally{v(!1)}},X=()=>{if(!N||!r.plazo||!r.fechaInicial){t.error("Todos los campos obligatorios deben estar completos y válidos.");return}U(()=>W),y(!0)},_=r.idOrigenCapital==="1"?"Origen Local: Se aplica un mes de gracia para el Impuesto a la Salida de Divisas (ISD).":r.idOrigenCapital==="2"?"Origen Extranjero: No aplica mes de gracia para ISD, pero se validará que el depósito provenga de una entidad financiera extranjera autorizada.":"Primero selecciona un origen de capital para más información.",ee=J[r.idProducto]||"";return e.jsxs("div",{className:"space-y-6 p-6 relative",children:[e.jsx(se,{visible:$,message:"Procesando..."}),e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h2",{className:"text-2xl font-semibold text-gray-800",children:"Nueva Proyección"})}),e.jsx(L,{className:"border border-gray-700 shadow-sm bg-white rounded-2xl",children:e.jsxs(M,{className:"p-6 space-y-8",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800",children:"Datos para la proyección"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"flex flex-col justify-center",children:[e.jsx(w,{className:"text-sm font-medium text-gray-700",children:"Tipo de solicitud"}),e.jsx("div",{className:"mt-1 p-2 rounded bg-gray-100 border border-gray-300 text-gray-800 font-semibold",children:"Nueva"})]}),e.jsx(I,{label:"Producto",value:r.idProducto,onChange:a=>j("idProducto",a),options:["1","2","3","4","5"],labels:["Renta Fija","Renta Periódica Mensual","Renta Periódica Bimensual","Renta Periódica Trimestral","Renta Periódica Semestral"],disabled:m}),e.jsx(V,{label:"Capital",value:r.capital,onChange:a=>j("capital",a.target.value),disabled:m,placeholder:"$"})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-300 rounded p-3 text-sm text-blue-800 italic font-medium",children:ee}),N&&e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-6",children:[e.jsx("div",{className:"relative",children:e.jsx(I,{label:e.jsxs("div",{className:"flex items-center gap-1",children:["Origen del capital",e.jsx(ve,{content:_,children:e.jsx(le,{className:"w-4 h-4 text-gray-500 cursor-help"})})]}),value:r.idOrigenCapital,onChange:a=>j("idOrigenCapital",a),options:["1","2"],labels:["Local","Extranjero"],disabled:m})}),e.jsx(I,{label:"Plazo",value:r.plazo,onChange:a=>j("plazo",a),options:R,labels:R.map(a=>`${a} meses`),disabled:m}),e.jsx(V,{label:"Fecha inicial",type:"date",value:r.fechaInicial,onChange:a=>{const s=a.target.value;s===""||T(s)?j("fechaInicial",s):t.error("Fecha inválida. Solo 01, 10 o 20 de meses actuales o futuros permitidos.")},disabled:m})]}),e.jsx("input",{type:"hidden",value:0,readOnly:!0}),O!==null&&e.jsx("div",{className:"bg-blue-100 border border-blue-300 rounded-xl p-4 flex justify-center items-center mt-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-blue-600 font-medium",children:"Tasa asignada"}),e.jsxs("p",{className:"text-3xl font-bold text-blue-800",children:[O.toFixed(2),"%"]})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-4 pt-4",children:[e.jsx(S,{onClick:Q,disabled:m,className:"bg-blue-600 hover:bg-blue-800 text-white shadow",children:"Consultar tasa"}),e.jsx(S,{onClick:X,disabled:m||!E,className:"bg-green-600 hover:bg-green-800 text-white shadow",children:"Generar cronograma"})]})]})}),g.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"mt-6",children:e.jsx(M,{children:e.jsx(ye,{data:g,columns:[{key:"periodo",label:"Período",render:a=>e.jsx("div",{className:"text-center",children:a})},{key:"fechaInicial",label:"F. Inicial",render:a=>e.jsx("div",{className:"text-center",children:A(a)})},{key:"fechaVencimiento",label:"F. Vencimiento",render:a=>e.jsx("div",{className:"text-center",children:A(a)})},{key:"tasa",label:"Tasa",render:a=>e.jsxs("div",{className:"text-center",children:[a.toFixed(2),"%"]})},{key:"aporteAdicional",label:"Aporte Adic.",render:a=>e.jsx("div",{className:"text-right",children:o(a)})},{key:"capitalOperacion",label:"Capital",render:a=>e.jsx("div",{className:"text-right",children:o(a)})},{key:"rentabilidad",label:"Rentabilidad",render:a=>e.jsx("div",{className:"text-right",children:o(a)})},{key:"capitalRenta",label:"Capital Renta",render:a=>e.jsx("div",{className:"text-right",children:o(a)})},{key:"costoOperativo",label:"Coste Op.",render:a=>e.jsx("div",{className:"text-right",children:o(a)})},{key:"rentaAcumulada",label:"Renta Acum.",render:a=>e.jsx("div",{className:"text-right",children:o(a)})},{key:"capitalFinal",label:"Capital Final",render:a=>e.jsx("div",{className:"text-right",children:o(a)})},{key:"montoPagar",label:"Monto a Pagar",render:a=>e.jsx("div",{className:"text-right",children:o(a)})}],mostrarAgregarNuevo:!1,mostrarEditar:!1,mostrarEliminar:!1})})}),l&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 mt-6",children:[e.jsx(x,{label:"Coste Operativo Total",value:l.totalCosteOperativo}),e.jsx(x,{label:"Rentabilidad Total",value:l.totalRentabilidad}),e.jsx(x,{label:"Renta Total",value:l.totalRentaPeriodo}),e.jsx(x,{label:"Capital + Rendimiento",value:l.rendimientosMasCapital}),e.jsx(x,{label:"Valor a Liquidar",value:l.valorProyectadoLiquidar}),r.tipoSolicitud==="3"&&l.fechaIncremento&&e.jsx(x,{label:"Fecha Incremento",value:new Date(l.fechaIncremento).toLocaleDateString()})]})]}),e.jsx(xe,{open:G,onOpenChange:y,children:e.jsxs(he,{className:"backdrop-blur-md max-w-md",children:[e.jsx(fe,{children:e.jsx(be,{children:"¿Generar cronograma?"})}),e.jsx("p",{className:"text-sm text-gray-500",children:"¿Estás seguro de que deseas generar el cronograma?"}),e.jsxs(je,{className:"pt-4",children:[e.jsx(S,{variant:"outline",onClick:()=>y(!1),children:"Cancelar"}),e.jsx(S,{className:"bg-primary text-white hover:bg-primary/70",onClick:()=>{y(!1),z&&z()},children:"Confirmar"})]})]})})]})}function V({label:i,value:t,onChange:d,type:r="text",disabled:p,placeholder:g}){return e.jsxs("div",{className:"space-y-1",children:[e.jsx(w,{className:"text-sm text-gray-700 font-medium",children:i}),e.jsx(ne,{type:r,value:t,onChange:d,disabled:p,className:"text-sm border-gray-700 bg-white",placeholder:g})]})}function I({label:i,value:t,onChange:d,options:r,labels:p=[],disabled:g}){return e.jsxs("div",{className:"space-y-1",children:[e.jsx(w,{className:"text-sm text-gray-700 font-medium",children:i}),e.jsxs(de,{value:t,onValueChange:d,disabled:g,children:[e.jsx(me,{className:"text-sm border-gray-700 bg-white",children:e.jsx(ue,{placeholder:i})}),e.jsx(pe,{className:"bg-white",children:r.map((h,l)=>e.jsx(ge,{value:h,children:p[l]??h},h))})]})]})}function x({label:i,value:t}){return e.jsxs("div",{className:"bg-gray-100 rounded-lg p-4 text-center",children:[e.jsx("div",{className:"text-xs text-gray-500",children:i}),e.jsx("div",{className:"text-lg font-semibold text-gray-800",children:typeof t=="number"?o(t):t})]})}export{Oe as default};
