import{A as _,r as n,j as e,G as K,I as z,L as W,B as y,t as P,f as ce,u as ue,c as me,h as xe}from"./index-ABbIRX4x.js";import{T as R}from"./TablaCustom2-DS7_i3Ng.js";import{A as V,a as $,b as B,c as U,d as Q,e as X,f as Y}from"./alert-dialog-BbB2nhGe.js";import{D as pe,a as he}from"./jspdf.plugin.autotable-CZR7NrjE.js";import{T as ge}from"./textarea-B4rIvIUE.js";import{S as O,a as F,b as L,c as M,d as S}from"./select-C75wXMdb.js";import be from"./SolicitudInversionForm-Bb3Az7kz.js";import{a as ve}from"./ProspectoService-DqbVOVKq.js";import{e as je}from"./SolicitudService-BRPNL4PC.js";import{g as fe}from"./PrioridadService-Bo9Ks_UM.js";import{g as ye}from"./TipoActividadService-BNx9c6j8.js";import"./index-CFqNEq9z.js";import"./TipoClienteService-BAK64bBK.js";import"./TipoIdentificacionService-BJmrDHaB.js";const q=async r=>{if(!r.ok){const s=await r.text();throw new Error(s||"Error en la solicitud")}return await r.json()},G=()=>{var s;return{"Content-Type":"application/json",Authorization:`Bearer ${(s=JSON.parse(localStorage.getItem("user")))==null?void 0:s.token}`}},Ne=async r=>{const s=await fetch(`${_}/vista/actividad/filtrar?por=IdProspecto&id=${r}`,{headers:G()});return q(s)},Ae=async r=>{const s={IdTipoActividad:Number(r.idTipoActividad),Asunto:r.asunto,Descripcion:r.descripcion,Duracion:r.duracion,Vencimiento:r.vencimiento,IdPrioridad:Number(r.idPrioridad),Estado:!!r.estado,IdProspecto:Number(r.idProspecto),IdUsuarioPropietario:r.idUsuarioPropietario??null,FechaCreacion:r.fechaCreacion??null},x=await fetch(`${_}/Actividad`,{method:"POST",headers:G(),body:JSON.stringify(s)});return q(x)},we=async(r,s)=>{const x={IdActividad:Number(r),IdTipoActividad:Number(s.idTipoActividad),Asunto:s.asunto,Descripcion:s.descripcion,Duracion:s.duracion,Vencimiento:s.vencimiento,IdPrioridad:Number(s.idPrioridad),Estado:!!s.estado,IdProspecto:Number(s.idProspecto),IdUsuarioPropietario:s.idUsuarioPropietario??null,FechaCreacion:s.fechaCreacion??null},d=await fetch(`${_}/Actividad/${r}`,{method:"PUT",headers:G(),body:JSON.stringify(x)});return q(d)};function J({open:r,onClose:s,onActividadCreada:x,modo:d,actividadEditar:i=null,tiposActividad:C=[],prioridades:N=[],idProspecto:T}){const[k,A]=n.useState(!1),[o,h]=n.useState({idTipoActividad:"",asunto:"",descripcion:"",duracion:"",vencimiento:"",idPrioridad:"",estado:"En progreso"}),[I,g]=n.useState(!1);n.useEffect(()=>{var a,l;r&&h(d==="editar"&&i?{idTipoActividad:((a=i.idTipoActividad)==null?void 0:a.toString())??"",asunto:i.asunto??"",descripcion:i.descripcion??"",duracion:i.duracion?D(i.duracion):"",vencimiento:i.vencimiento?i.vencimiento.substring(0,16):"",idPrioridad:((l=i.idPrioridad)==null?void 0:l.toString())??"",estado:i.estado?"Finalizada":"En progreso"}:{idTipoActividad:"",asunto:"",descripcion:"",duracion:"",vencimiento:"",idPrioridad:"",estado:"En progreso"})},[r,i,d]);function D(a){if(!a)return"";const[l,c]=a.split(":").map(Number);return(l*60+c).toString()}function w(a){if(!a)return"00:00:00";const l=String(Math.floor(a/60)).padStart(2,"0"),c=String(a%60).padStart(2,"0");return`${l}:${c}:00`}const p=(a,l)=>h(c=>({...c,[a]:l})),j=async a=>{if(a.preventDefault(),!o.idTipoActividad||!o.asunto.trim()||!o.descripcion.trim()||!o.duracion||!o.vencimiento||!o.idPrioridad){g(!0);return}A(!0);const l={idTipoActividad:parseInt(o.idTipoActividad),asunto:o.asunto,descripcion:o.descripcion,duracion:w(parseInt(o.duracion)),vencimiento:o.vencimiento,idPrioridad:parseInt(o.idPrioridad),estado:o.estado==="Finalizada",idProspecto:T};try{d==="editar"&&i?(await we(i.idActividad,{...l,idUsuarioPropietario:i.idUsuarioPropietario??null,fechaCreacion:i.fechaCreacion??null}),P.success("Actividad actualizada correctamente.")):(await Ae(l),P.success("Actividad creada correctamente.")),x==null||x(),s==null||s()}catch(c){P.error("Error al guardar actividad: "+((c==null?void 0:c.message)||c))}finally{A(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx(K,{visible:k,message:d==="editar"?"Guardando cambios...":"Guardando actividad..."}),e.jsx(pe,{open:r,onOpenChange:s,children:e.jsx(he,{className:"max-w-2xl w-full p-0",children:e.jsx("div",{className:"relative px-2 py-3 md:px-7 md:py-7",children:e.jsxs("form",{onSubmit:j,className:"space-y-8",autoComplete:"off",children:[e.jsxs("section",{className:"bg-white rounded-2xl border border-gray-200 px-7 py-5 flex flex-col gap-4 shadow-lg transition-colors",children:[e.jsx("h3",{className:"font-semibold text-lg text-violet-700 mb-3 border-b pb-2",children:d==="editar"?"Editar Actividad":"Nueva Actividad"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5",children:[e.jsx(v,{label:"Tipo de Actividad",children:e.jsxs(O,{value:o.idTipoActividad,onValueChange:a=>p("idTipoActividad",a),required:!0,children:[e.jsx(F,{children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsx(M,{className:"bg-white",children:C.map(a=>e.jsx(S,{value:a.idTipoActividad.toString(),children:a.descripcion},a.idTipoActividad))})]})}),e.jsx(v,{label:"Prioridad",children:e.jsxs(O,{value:o.idPrioridad,onValueChange:a=>p("idPrioridad",a),required:!0,children:[e.jsx(F,{children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsx(M,{className:"bg-white",children:N.map(a=>e.jsx(S,{value:a.idPrioridad.toString(),children:a.categoria},a.idPrioridad))})]})}),e.jsx(v,{label:"Asunto",children:e.jsx(z,{placeholder:"Ej: Seguimiento telefónico",value:o.asunto,maxLength:100,onChange:a=>p("asunto",a.target.value),required:!0})}),e.jsx(v,{label:"Duración (min)",children:e.jsx(z,{type:"number",placeholder:"Ej: 30",value:o.duracion,min:1,max:480,onChange:a=>p("duracion",a.target.value),required:!0})}),e.jsx(v,{label:"Vencimiento",children:e.jsx(z,{type:"datetime-local",value:o.vencimiento,onChange:a=>p("vencimiento",a.target.value),required:!0})}),d==="editar"&&e.jsx(v,{label:"Estado",children:e.jsxs(O,{value:o.estado,onValueChange:a=>p("estado",a),required:!0,children:[e.jsx(F,{children:e.jsx(L,{placeholder:"Seleccionar..."})}),e.jsxs(M,{className:"bg-white",children:[e.jsx(S,{value:"En progreso",children:"En progreso"}),e.jsx(S,{value:"Finalizada",children:"Finalizada"})]})]})}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(W,{className:"text-sm text-gray-700 font-medium",children:"Descripción"}),e.jsx(ge,{rows:3,value:o.descripcion,onChange:a=>p("descripcion",a.target.value),placeholder:"Descripción",className:"text-sm border-gray-300",required:!0})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[e.jsx(y,{type:"button",variant:"outline",onClick:s,className:"px-6 py-2",children:"Cancelar"}),e.jsx(y,{type:"submit",className:"bg-violet-600 hover:bg-violet-700 text-white px-6 py-2",children:d==="editar"?"Guardar Cambios":"Crear Actividad"})]})]})})})}),e.jsx(V,{open:I,onOpenChange:g,children:e.jsxs($,{className:"bg-white border border-yellow-300 rounded-xl shadow-xl p-7 max-w-md",children:[e.jsxs(B,{children:[e.jsx(U,{className:"text-yellow-700",children:"Faltan campos obligatorios"}),e.jsx("div",{className:"text-gray-700 mt-2",children:"Completa todos los campos antes de continuar."})]}),e.jsxs(Q,{children:[e.jsx(X,{className:"border border-gray-300 bg-white hover:bg-gray-50",children:"Cerrar"}),e.jsx(Y,{asChild:!0,children:e.jsx("button",{className:"bg-violet-600 text-white hover:bg-violet-700 px-4 py-2 rounded",onClick:()=>g(!1),type:"button",children:"OK"})})]})]})})]})}function v({label:r,children:s}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(W,{className:"font-medium text-gray-700 text-sm",children:r}),s]})}const Se={1:{label:"Llenado de Información",color:"bg-yellow-100 text-yellow-700"},2:{label:"Tareas Generadas",color:"bg-blue-100 text-blue-700"},3:{label:"Solicitud Rechazada",color:"bg-red-100 text-red-700"},4:{label:"Completada",color:"bg-green-100 text-green-700"}};function Be(){const{id:r}=ce(),s=ue(),{roles:x}=me(),d=x.includes("Externo"),[i,C]=n.useState(null),[N,T]=n.useState([]),[k,A]=n.useState([]),[o,h]=n.useState(!0),[I,g]=n.useState(!1),[D,w]=n.useState(!1),[p,j]=n.useState(!1),[a,l]=n.useState(null),[c,Z]=n.useState([]),[H,ee]=n.useState([]),[ie,E]=n.useState(!1);n.useEffect(()=>{h(!0),b()},[r]);const b=async()=>{try{const[t,m,u,le,de]=await Promise.all([ve(r),Ne(r),je(r),ye(),fe()]);C(t),T(m),A(u),Z(le),ee(de)}catch(t){P.error("Error al cargar prospecto: "+t.message)}finally{h(!1)}},ae=N.some(t=>t.estado===!0),re=()=>{if(!(i!=null&&i.esCliente)){if(!d&&!ae){E(!0);return}j(!0)}},se=()=>{i!=null&&i.esCliente||g(!0)},f=!!(i!=null&&i.esCliente),te=[{key:"idActividad",label:"",render:t=>e.jsxs("div",{className:"flex items-center justify-center group relative text-gray-500",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",strokeWidth:"1.5",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 17h6m-6-4h6m2 9a2 2 0 002-2V7a2 2 0 00-2-2h-3.586a1 1 0 01-.707-.293l-1.414-1.414A1 1 0 0011.586 3H9a2 2 0 00-2 2v14a2 2 0 002 2h6z"})}),e.jsxs("span",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-1 text-xs text-white bg-zinc-800 px-2 py-0.5 rounded shadow opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-50 whitespace-nowrap",children:["ID: ",t]})]})},{key:"nombreTipoActividad",label:"Tipo"},{key:"estado",label:"Estado",render:t=>e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full ${t?"bg-emerald-100 text-emerald-700":"bg-yellow-200 text-yellow-700"}`,children:t?"Finalizada":"En Progreso"})},{key:"asunto",label:"Asunto"},{key:"descripcion",label:"Descripción",render:t=>e.jsx("span",{className:"max-w-12 truncate block",children:t})},{key:"duracion",label:"Duración"},{key:"vencimiento",label:"Vencimiento"},{key:"nombrePrioridad",label:"Prioridad"}],oe=[{key:"idSolicitudInversion",label:"",render:t=>e.jsxs("div",{className:"flex items-center justify-center group relative text-gray-500",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",strokeWidth:"1.5",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12h6m-6 4h6M5 4v16h14V4H5zm2 2h10v12H7V6z"})}),e.jsxs("span",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-1 text-xs text-white bg-zinc-800 px-2 py-0.5 rounded shadow opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-50 whitespace-nowrap",children:["ID: ",t]})]})},{key:"numeroDocumento",label:"N° Documento",render:(t,m)=>{var u;return((u=m.identificacion)==null?void 0:u.numeroDocumento)||"—"}},{key:"nombreTipoSolicitud",label:"Tipo Solicitud",render:(t,m)=>{var u;return((u=m.identificacion)==null?void 0:u.nombreTipoSolicitud)||"—"}},{key:"nombreTipoCliente",label:"Tipo Cliente",render:(t,m)=>{var u;return((u=m.identificacion)==null?void 0:u.nombreTipoCliente)||"—"}},{key:"nombreTipoDocumento",label:"Tipo Documento",render:(t,m)=>{var u;return((u=m.identificacion)==null?void 0:u.nombreTipoDocumento)||"—"}},{key:"faseProceso",label:"Fase Proceso",render:t=>{const m=Se[t]||{label:"Desconocido",color:"bg-gray-100 text-gray-500"};return e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full ${m.color}`,children:m.label})}}];if(o||!i)return e.jsx(K,{visible:!0,message:"Cargando prospecto..."});const ne=i!=null&&i.esCliente?e.jsx("span",{className:"bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-semibold ml-2",children:"Cliente"}):e.jsx("span",{className:"bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-semibold ml-2",children:"Prospecto"});return e.jsxs("div",{className:"p-6 md:p-10 max-w-7xl mx-auto relative",children:[f&&e.jsxs("div",{className:"w-full flex items-center px-6 py-2 bg-gray-50 border-b border-gray-300 shadow-sm mb-4 z-50 rounded-t-xl",style:{position:"sticky",top:0},children:[e.jsx(xe,{className:"text-gray-700 w-5 h-5 mr-2"}),e.jsx("span",{className:"font-semibold text-gray-700 text-sm",children:"Solo lectura: este prospecto ya es cliente. No se pueden agregar actividades ni solicitudes."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 mb-3",children:[e.jsx(y,{variant:"outline",onClick:()=>s("/prospectos/vista"),className:"px-5 py-2",children:"← Volver"}),e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:[i==null?void 0:i.nombres," ",i==null?void 0:i.apellidoPaterno," ",i==null?void 0:i.apellidoMaterno]}),e.jsxs("span",{className:"text-base text-gray-500 ml-2",children:[e.jsx("b",{children:"ID:"})," ",i==null?void 0:i.idProspecto]}),ne]}),e.jsxs("div",{className:"flex flex-wrap text-xs text-gray-700 mb-6 border-b pb-2 gap-8",children:[e.jsxs("span",{children:[e.jsx("b",{children:"Correo:"})," ",(i==null?void 0:i.correoElectronico)||"-"]}),e.jsxs("span",{children:[e.jsx("b",{children:"Teléfono:"})," ",(i==null?void 0:i.telefonoCelular)||"-"]}),e.jsxs("span",{children:[e.jsx("b",{children:"Tipo Identificación:"})," ",(i==null?void 0:i.tipoIdentificacion)||"-"]}),e.jsxs("span",{children:[e.jsx("b",{children:"Origen:"})," ",(i==null?void 0:i.nombreOrigen)||"-"]}),e.jsxs("span",{children:[e.jsx("b",{children:"Producto Interés:"})," ",(i==null?void 0:i.productoInteres)||"-"]}),e.jsxs("span",{children:[e.jsx("b",{children:"Agencia:"})," ",(i==null?void 0:i.agencia)||"-"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 items-start",children:[e.jsx("section",{className:"p-0 flex flex-col gap-4 min-h-[360px] col-span-1 bg-transparent",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-800 mb-2",children:"Opciones"}),!d&&e.jsx(y,{className:"bg-violet-600 hover:bg-violet-700 text-white w-full",disabled:f,onClick:se,children:"+ Agregar actividad"}),e.jsx(y,{className:"bg-violet-600 hover:bg-violet-700 text-white w-full mt-4",disabled:f,onClick:re,children:"+ Crear solicitud de inversión"})]})}),e.jsxs("section",{className:"col-span-2 flex flex-col gap-8",children:[!d&&e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-4 mb-2",children:e.jsx("span",{className:"font-semibold text-lg text-gray-700",children:"Actividades"})}),e.jsx(R,{columns:te,data:N,mostrarEditar:!f,mostrarAgregarNuevo:!1,mostrarEliminar:!f,onEditarClick:t=>{l(t),w(!0)}})]}),e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-4 mb-2",children:e.jsx("span",{className:"font-semibold text-lg text-gray-700",children:"Solicitudes de Inversión"})}),e.jsx(R,{columns:oe,data:k,mostrarEditar:!0,mostrarAgregarNuevo:!1,mostrarEliminar:!1,onEditarClick:t=>s(`/solicitudes/editar/${t.idSolicitudInversion}`)})]})]})]}),e.jsx(V,{open:p,onOpenChange:j,children:e.jsxs($,{className:"bg-white border border-gray-300 rounded-xl shadow-xl p-7 max-w-4xl w-full",children:[e.jsxs(B,{children:[e.jsx(U,{children:"Agregar Solicitud"}),e.jsx("div",{className:"text-gray-700 mb-2",children:"Completa la información de la solicitud."})]}),e.jsx(be,{idProspecto:r,modo:"crear",onClose:()=>{j(!1),b()}})]})}),e.jsx(J,{open:I,onClose:()=>{g(!1),l(null),b()},idProspecto:r,modo:"crear",onActividadCreada:b,tiposActividad:c,prioridades:H}),e.jsx(J,{open:D,onClose:()=>{w(!1),l(null),b()},idProspecto:r,modo:"editar",actividadEditar:a,onActividadCreada:b,tiposActividad:c,prioridades:H}),e.jsx(V,{open:ie,onOpenChange:E,children:e.jsxs($,{className:"bg-white border border-yellow-300 rounded-xl shadow-xl p-7 max-w-md",children:[e.jsxs(B,{children:[e.jsx(U,{className:"text-yellow-700",children:"No hay actividades finalizadas"}),e.jsxs("div",{className:"text-gray-700 mt-2",children:["Para crear una solicitud de inversión, primero debe registrar al menos ",e.jsx("b",{children:"una actividad finalizada"}),' (en estado "Finalizada") para este prospecto.']})]}),e.jsxs(Q,{children:[e.jsx(X,{className:"border border-gray-300 bg-white hover:bg-gray-50",children:"Cerrar"}),e.jsx(Y,{asChild:!0,children:e.jsx("button",{className:"bg-violet-600 text-white hover:bg-violet-700 px-4 py-2 rounded",onClick:()=>E(!1),type:"button",children:"OK"})})]})]})})]})}export{Be as default};
