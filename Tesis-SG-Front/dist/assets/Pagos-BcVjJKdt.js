import{f as V,u as W,c as J,r,j as e,G as K,h as Q,B as C,t as i}from"./index-ABbIRX4x.js";import{u as L,g as X,a as Y,b as Z,r as _}from"./PagosService-zqIVeg-f.js";import{g as ee}from"./CalendarioOperacionesService-Pd8v99_L.js";import{T as ae}from"./TablaCustom2-DS7_i3Ng.js";import{S as se}from"./switch-BQg2MTGH.js";import{A as re,a as te,b as oe,c as le,d as ne,e as ie,f as ce}from"./alert-dialog-BbB2nhGe.js";import"./jspdf.plugin.autotable-CZR7NrjE.js";import"./index-CFqNEq9z.js";function ye(){const{id:m}=V(),g=W(),{user:t}=J(),[s,y]=r.useState(null),[o,D]=r.useState(null),[b,G]=r.useState([]),[R,v]=r.useState(!0),[p,c]=r.useState(!1),[P,S]=r.useState(""),[de,F]=r.useState(!1),[h,$]=r.useState(!1),[k,z]=r.useState(!1),[x,A]=r.useState({open:!1}),[B,E]=r.useState(!1),f=async()=>{v(!0);try{const a=await X(m);if(y(a),S((a==null?void 0:a.detalle)??""),F(!!(a!=null&&a.generarPagos)),$(!!(a!=null&&a.confirmarRegistrosPagos)),z(!!(a!=null&&a.descartarPagos)),a!=null&&a.idCalendario){const q=await ee(a.idCalendario);D(q)}const n=await Y(m);G(Array.isArray(n)?n:[])}catch(a){i.error("Error al cargar pago/casos: "+(a.message??a))}finally{v(!1)}};r.useEffect(()=>{f()},[m]);const l=!!(s!=null&&s.confirmarRegistrosPagos),d=!!(s!=null&&s.generarPagos),T=Array.isArray(b)&&b.length>0,j=a=>A({open:!0,...a}),u=()=>A({open:!1}),I=()=>{!d&&!l&&j({title:"¿Está seguro de generar los casos de pago?",description:"Esto generará todos los casos de pago asociados a este calendario.",confirmLabel:"Sí, generar",onConfirm:async()=>{c(!0);try{await Z({idCalendario:s.idCalendario,idPago:s.idPago,idUsuario:(t==null?void 0:t.id)??s.idUsuarioPropietario}),i.success("Casos de pago generados correctamente"),u(),await f()}catch(a){i.error("Error al generar casos de pago: "+(a.message??a)),u()}finally{c(!1)}}})},O=()=>{if(!d||l||h)return;if(b.filter(n=>n.estado!=="Cerrado").length>0){E(!0);return}j({title:"¿Está seguro de confirmar el registro de pagos?",description:"Al confirmar, este pago será cerrado y no podrá modificarse.",confirmLabel:"Sí, confirmar",onConfirm:async()=>{c(!0);try{await L(s.idPago,{...s,confirmarRegistrosPagos:!0}),i.success("Pago confirmado y cerrado correctamente"),u(),await f()}catch(n){i.error("Error al confirmar pagos: "+(n.message??n)),u()}finally{c(!1)}}})},U=()=>{!d||l||h||j({title:"¿Está seguro de descartar todos los pagos?",description:"Esto eliminará todos los casos de pago generados para este calendario. Podrás generarlos de nuevo.",confirmLabel:"Sí, descartar",onConfirm:async()=>{c(!0);try{await _(s.idPago,(t==null?void 0:t.id)??s.idUsuarioPropietario),i.success("Pagos y casos descartados correctamente, puedes volver a generarlos."),u(),await f()}catch(a){i.error("Error al descartar pagos: "+(a.message??a)),u()}finally{c(!1)}}})},H=[{key:"numeroCaso",label:"Título de caso",render:(a,n)=>e.jsx("span",{className:"font-mono text-violet-700 cursor-pointer hover:underline",onClick:()=>g(`/casos/editar/${n.idCaso}`),children:a})},{key:"motivoNombre",label:"Motivo"},{key:"nombreCliente",label:"Cliente"},{key:"fechaPago",label:"Fecha de pago",render:a=>a?new Date(a).toLocaleDateString():""},{key:"montoPago",label:"Monto de pago",render:a=>a!=null?`$${Number(a).toLocaleString("es-EC",{minimumFractionDigits:2})}`:""},{key:"numeroCuentaPago",label:"Cuenta de pago"},{key:"estado",label:"Estado",render:a=>e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full ${a==="Cerrado"?"bg-gray-300 text-gray-700":"bg-blue-100 text-blue-700"}`,children:a})}];if(R)return e.jsx(K,{visible:!0,message:"Cargando pago..."});const M=s!=null&&s.confirmarRegistrosPagos?e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-gray-300 text-gray-700 font-semibold",children:"Cerrado"}):e.jsx("span",{className:"px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800 font-semibold",children:"Pendiente"});return e.jsxs("div",{className:"p-6 md:p-10 max-w-7xl mx-auto bg-white rounded-2xl shadow-lg relative",children:[l&&e.jsxs("div",{className:"w-full flex items-center px-6 py-2 bg-gray-50 border-b border-gray-300 shadow-sm mb-4 z-50 rounded-t-xl",style:{position:"sticky",top:0},children:[e.jsx(Q,{className:"text-gray-700 w-5 h-5 mr-2"}),e.jsxs("span",{className:"font-semibold text-gray-700 text-sm",children:["Solo lectura: estado de este registro: ",e.jsx("span",{className:"text-violet-700",children:"Cerrado"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 mb-3",children:[e.jsx(C,{variant:"outline",onClick:()=>g("/pagos/vista"),className:"px-5 py-2",children:"← Volver"}),e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-3",children:["Pagos ",(o==null?void 0:o.nombre)||""]}),e.jsx("span",{className:"text-sm text-gray-500 ml-2",children:M})]}),e.jsxs("div",{className:"flex flex-wrap text-xs text-gray-700 mb-6 border-b pb-2 gap-8",children:[e.jsxs("span",{children:[e.jsx("b",{children:"Calendario:"})," ",(o==null?void 0:o.nombre)||"-"]}),e.jsxs("span",{children:[e.jsx("b",{children:"Creado:"})," ",s!=null&&s.fechaCreacion?new Date(s.fechaCreacion).toLocaleString("es-EC"):"-"]}),e.jsxs("span",{children:[e.jsx("b",{children:"Detalle:"})," ",s==null?void 0:s.detalle]})]}),e.jsxs("form",{onSubmit:a=>a.preventDefault(),className:"grid grid-cols-1 lg:grid-cols-3 gap-8 items-start",children:[e.jsxs("section",{className:"border rounded-xl p-6 shadow-sm flex flex-col gap-4 min-h-[360px] col-span-1",children:[e.jsx(w,{label:"Calendario de pagos",children:e.jsx("input",{type:"text",className:"w-full border rounded-md p-2 bg-gray-100 text-gray-500 font-medium",value:(o==null?void 0:o.nombre)||"",disabled:!0})}),e.jsx("div",{className:"font-semibold text-gray-800 mb-2",children:"Opciones"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{label:"Generar casos de pago",checked:d,onCheckedChange:I,disabled:d||l,rightLabel:d?"Sí":"No",border:!0}),e.jsx(N,{label:"Confirmar registros de pago",checked:h,onCheckedChange:O,disabled:!d||l||!T||h,rightLabel:h?"Sí":"No",border:!0})]}),e.jsx(w,{label:"Detalles",children:e.jsx("textarea",{className:"w-full border rounded-md p-2 bg-white text-sm",rows:3,value:P,onChange:a=>S(a.target.value),disabled:l})}),e.jsx("div",{className:"pt-2",children:e.jsx(C,{type:"button",className:"bg-violet-600 hover:bg-violet-700 text-white w-full",onClick:async()=>{c(!0);try{await L(s.idPago,{...s,detalle:P}),i.success("Pago actualizado correctamente"),await f()}catch(a){i.error("Error al actualizar pago: "+(a.message??a))}finally{c(!1)}},disabled:l||p,children:p?"Guardando...":"Actualizar pago"})})]}),e.jsxs("section",{className:"border rounded-xl p-6 shadow-sm flex flex-col gap-4 min-h-[360px] col-span-2",children:[e.jsxs("div",{className:"flex items-center gap-6 mb-3",children:[e.jsx(w,{label:"Cantidad de pagos",className:"mb-0",children:e.jsx("input",{type:"text",className:"w-28 border rounded-md p-2 bg-gray-100",value:(s==null?void 0:s.cantidadPagos)??0,disabled:!0})}),e.jsx("div",{className:"flex items-center gap-2 ml-6",children:e.jsx(N,{label:"Descartar pagos",checked:k,onCheckedChange:U,disabled:!d||l||h,rightLabel:k?"Sí":"No",border:!0})})]}),e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"font-semibold text-md text-gray-700",children:"Casos de pago"})}),e.jsx(ae,{columns:H,data:b,mostrarEditar:!0,mostrarAgregarNuevo:!1,mostrarEliminar:!1,onEditarClick:a=>g(`/casos/editar/${a.idCaso}`)})]})]}),e.jsx(re,{open:x.open,onOpenChange:u,children:e.jsxs(te,{className:"bg-white border border-gray-300 rounded-xl shadow-xl p-7 max-w-md",children:[e.jsxs(oe,{children:[e.jsx(le,{className:"text-gray-900",children:x.title}),x.description&&e.jsx("div",{className:"text-gray-700 mt-2",children:x.description})]}),e.jsxs(ne,{children:[e.jsx(ie,{className:"border border-gray-300 bg-white hover:bg-gray-50",children:"Cancelar"}),e.jsx(ce,{asChild:!0,children:e.jsx("button",{className:"bg-violet-600 text-white hover:bg-violet-700 px-4 py-2 rounded",onClick:async a=>{a.preventDefault(),x.onConfirm&&await x.onConfirm()},type:"button",disabled:p,children:p?"Guardando...":x.confirmLabel||"Sí, continuar"})})]})]})}),B&&e.jsx("div",{className:"fixed inset-0 bg-black/20 flex justify-center items-center z-50",children:e.jsxs("div",{className:"bg-white p-7 rounded-xl shadow-lg max-w-sm w-full border border-yellow-400",children:[e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx("span",{className:"text-yellow-600 font-bold text-lg",children:"⚠️ Faltan casos por cerrar"})}),e.jsx("p",{className:"text-gray-800 mb-4",children:"No puedes confirmar los pagos porque hay casos pendientes de cerrar."}),e.jsx("div",{className:"flex justify-end gap-4 mt-2",children:e.jsx(C,{variant:"outline",onClick:()=>E(!1),children:"Cerrar"})})]})})]})}function N({label:m,checked:g,onCheckedChange:t,disabled:s,rightLabel:y,border:o}){return e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-sm select-none",children:m}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`
            px-2 py-0.5 
            flex items-center
          `,style:{minWidth:46,minHeight:28},children:e.jsx(se,{checked:g,onCheckedChange:t,disabled:s,className:`
              data-[state=checked]:bg-violet-400
              data-[state=unchecked]:bg-gray-200
              border border-gray-400
              transition-colors
              w-10 h-6
            `})}),e.jsx("span",{className:"ml-2 w-6 text-gray-700",children:y})]})]})}function w({label:m,children:g,className:t}){return e.jsxs("div",{className:`space-y-1.5 mb-2 ${t??""}`,children:[e.jsx("span",{className:"block font-medium text-gray-700 text-sm",children:m}),g]})}export{ye as default};
