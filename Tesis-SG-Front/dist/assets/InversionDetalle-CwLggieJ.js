import{c as $,r as c,t as x,j as e,G as S,I as M,B as P,L as O,f as z,u as T,C as v,a as A}from"./index-ABbIRX4x.js";import{a as V,b as G,e as q,f as B,c as F,T as R,d as K}from"./TablaCustom2-DS7_i3Ng.js";import{a as J}from"./InversionService-CD1AeE6A.js";import{f as U,h as W}from"./AdendumService-DLpFzeby.js";import{a as H}from"./ProyeccionService-PEcHVMkt.js";import{D as X,a as Y}from"./jspdf.plugin.autotable-CZR7NrjE.js";import{R as _,L as Q,C as Z,X as ee,Y as ae,T as te,a as le,b as k}from"./LineChart-BcUwHWs0.js";function re({inversion:l,cronograma:o,onClose:i,onSaved:p}){const{user:a}=$(),[h,w]=c.useState(o||[]),[d,u]=c.useState({periodoIncremento:"",montoIncremento:""}),[b,g]=c.useState(!1);c.useEffect(()=>{!o&&(l!=null&&l.idProyeccion)&&(g(!0),H(l.idProyeccion).then(r=>w(Array.isArray(r)?r:[])).catch(()=>x.error("No se pudo cargar el cronograma")).finally(()=>g(!1)))},[l,o]);const j=r=>{const f=h.find(m=>String(m.Periodo)===String(r));if(f&&Number(f.AporteAdicional)>0){x.error("No puedes realizar un incremento en este mes porque ya posee un adendum."),u(m=>({...m,periodoIncremento:""}));return}u(m=>({...m,periodoIncremento:r}))},y=r=>{const f=r.replace(/[^0-9.]/g,"").replace(/^(\d+\.\d{0,2}).*$/,"$1");u(m=>({...m,montoIncremento:f}))},I=async r=>{if(r.preventDefault(),!d.periodoIncremento){x.error("Selecciona el período de incremento.");return}if(!d.montoIncremento||isNaN(d.montoIncremento)||Number(d.montoIncremento)<=0){x.error("Ingresa un monto válido para el incremento.");return}if(!(l!=null&&l.idInversion)||!(l!=null&&l.idProyeccion)){x.error("No se encontró la inversión o proyección.");return}if(!(a!=null&&a.id)){x.error("No se detectó usuario.");return}g(!0);try{await U({idInversion:l.idInversion,idProyeccionOriginal:l.idProyeccion,periodoIncremento:Number(d.periodoIncremento),montoIncremento:Number(d.montoIncremento),idUsuarioCreacion:a.id}),x.success("Adendum creado correctamente."),p==null||p(),i==null||i()}catch{x.error("Error al crear adendum.")}finally{g(!1)}};return e.jsxs("div",{className:"relative px-2 py-3 md:px-7 md:py-7",children:[e.jsx(S,{visible:b,message:"Guardando adendum..."}),e.jsxs("form",{onSubmit:I,className:"space-y-8 max-w-lg mx-auto",autoComplete:"off",children:[e.jsxs("section",{className:"bg-white rounded-2xl border border-gray-200 px-7 py-5 flex flex-col gap-4 shadow-lg transition-colors",children:[e.jsx("h3",{className:"font-semibold text-lg text-violet-700 mb-3 border-b pb-2",children:"Crear Adendum de Incremento"}),e.jsx(L,{label:"Mes/Período de incremento",children:e.jsxs("select",{className:"input w-full rounded border-gray-300 py-2 px-3 text-sm",required:!0,value:d.periodoIncremento,onChange:r=>j(r.target.value),disabled:b||!h.length,children:[e.jsx("option",{value:"",children:"Selecciona un período..."}),h.map(r=>e.jsxs("option",{value:r.Periodo,disabled:Number(r.AporteAdicional)>0,children:[`Período ${r.Periodo} (${new Date(r.FechaInicial).toLocaleDateString("es-EC",{month:"short",year:"numeric"})})`,Number(r.AporteAdicional)>0?" (ya tiene incremento)":""]},r.Periodo))]})}),e.jsx(L,{label:"Monto del incremento",children:e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-2.5 text-gray-500 font-bold",children:"$"}),e.jsx(M,{className:"pl-7",type:"text",inputMode:"decimal",pattern:"^\\d+(\\.\\d{0,2})?$",placeholder:"0.00",maxLength:12,required:!0,value:d.montoIncremento,onChange:r=>y(r.target.value),disabled:b,autoComplete:"off"})]})})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[e.jsx(P,{type:"button",variant:"outline",onClick:i,className:"px-6 py-2",disabled:b,children:"Cancelar"}),e.jsx(P,{type:"submit",className:"bg-violet-600 hover:bg-violet-700 text-white px-6 py-2",disabled:b,children:"Guardar Adendum"})]})]})]})}function L({label:l,children:o}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(O,{className:"font-medium text-gray-700 text-sm",children:l}),o]})}const se={1:{label:"Creado",color:"bg-yellow-100 text-yellow-700 border-yellow-300"},2:{label:"Comprobante",color:"bg-blue-100 text-blue-700 border-blue-300"},3:{label:"Completado",color:"bg-emerald-100 text-emerald-700 border-emerald-300"}};function s(l){return l==null?"-":`$${Number(l).toLocaleString("es-EC",{minimumFractionDigits:2})}`}function N(l){return l?new Date(l).toLocaleDateString("es-EC",{day:"2-digit",month:"2-digit",year:"numeric"}):""}function oe(l){if(!l)return"";const o=/- ([^-]+) -/,i=l.match(o);return i&&i[1]?i[1].trim():""}function be(){const{id:l}=z(),o=T(),[i,p]=c.useState(!0),[a,h]=c.useState(null),[w,d]=c.useState([]),[u,b]=c.useState([]),[g,j]=c.useState(!1),y=(a==null?void 0:a.terminada)===!0,I=async()=>{p(!0);try{const t=await J(l);h(t);let n=[];if(t!=null&&t.periodosJson)try{n=JSON.parse(t.periodosJson)}catch{n=[]}if(b(Array.isArray(n)?n:[]),t!=null&&t.idInversion)try{const C=await W(t.idInversion);d((C==null?void 0:C.adendums)||[])}catch{d([])}}catch{h(null),x.error("No se pudo cargar la inversión.")}p(!1)};c.useEffect(()=>{I()},[l]);const r=[{key:"idAdendum",label:"",render:(t,n)=>e.jsx("span",{className:"flex justify-center items-center cursor-pointer",title:"Ver detalle de Adendum",onClick:()=>o(`/adendum/vista/${n.idAdendum}`),children:e.jsx(K,{className:"text-violet-600 hover:text-violet-800",size:18})})},{key:"nombreAdendum",label:"Nombre"},{key:"estado",label:"Estado",render:t=>{const n=se[t]||{label:"Desconocido",color:"bg-gray-100 text-gray-700 border-gray-300"};return e.jsx("span",{className:`px-2 py-1 text-xs font-bold rounded-full border ${n.color}`,children:n.label})}},{key:"fechaCreacion",label:"F. Creación",render:t=>N(t)}],f=u.map(t=>({Periodo:`P${t.Periodo}`,Capital:t.Capital,Rentabilidad:t.Rentabilidad,MontoPagar:t.MontoPagar})),m=[{label:"Producto",value:e.jsx("b",{children:oe(a==null?void 0:a.inversionNombre)})},{label:"Plazo",value:e.jsx("b",{children:a!=null&&a.plazo?`${a.plazo} meses`:"-"})},{label:"Tasa",value:e.jsx("b",{children:a!=null&&a.tasa?`${Number(a.tasa).toFixed(2)}%`:"-"})},{label:"Estado",value:e.jsx("b",{children:y?"Finalizada":"Vigente"})}],D=[{label:"Capital",value:s(a==null?void 0:a.capital)},{label:"Aporte Adicional",value:s(a==null?void 0:a.aporteAdicional)},{label:"Valor a Liquidar",value:s(a==null?void 0:a.valorProyectadoLiquidar)},{label:"Capital + Rendimiento",value:s(a==null?void 0:a.rendimientosMasCapital)},{label:"Rentabilidad Total",value:s(a==null?void 0:a.totalRentabilidad)},{label:"Renta Total",value:s(a==null?void 0:a.totalRentaPeriodo)},{label:"Fecha Inicial",value:e.jsx("b",{children:N(a==null?void 0:a.fechaInicial)})},{label:"Fecha Vencimiento",value:e.jsx("b",{children:N(a==null?void 0:a.fechaVencimiento)})},{label:"Coste Operativo",value:s(a==null?void 0:a.totalCosteOperativo)},{label:"Coste Notarización",value:s(a==null?void 0:a.costeNotarizacion)}];return i?e.jsx(S,{visible:!0,message:"Cargando inversión..."}):a?e.jsxs("div",{className:"max-w-7xl mx-auto p-6 space-y-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-4 bg-white border-b pb-4 rounded-2xl px-4",children:[e.jsx(P,{variant:"outline",className:"flex items-center gap-2 mb-2 md:mb-0",onClick:()=>o("/inversiones/vista"),children:e.jsx(V,{})}),e.jsxs("div",{className:"flex-1 flex flex-col md:flex-row md:justify-between md:items-end gap-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"rounded-full w-12 h-12 bg-blue-100 flex items-center justify-center text-blue-600 text-2xl font-bold relative",children:[e.jsx(G,{}),y&&e.jsx("span",{title:"Inversión finalizada: solo lectura",className:"absolute -top-1 -right-1 bg-gray-800 text-white rounded-full p-1 text-xs flex items-center justify-center",children:e.jsx(q,{})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-md font-bold text-gray-800",children:[a.inversionNombre," ",e.jsx("span",{className:"font-normal text-gray-500",children:a.plazo?`(${a.plazo} meses)`:""})]}),e.jsx("div",{className:"text-lg text-blue-800 font-semibold",children:s(a.capital)})]})]})}),e.jsxs("div",{className:"flex flex-row gap-8",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"text-base text-gray-800 font-semibold flex items-center gap-2",children:[e.jsx(B,{className:"text-indigo-700"}),e.jsx("span",{children:a.usuarioPropietarioNombreCompleto||"Sin asignar"})]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Propietario"})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"text-base text-blue-900 font-semibold",children:a.nombreCompletoCliente}),e.jsx("div",{className:"text-xs text-gray-400",children:"Cliente"})]})]}),e.jsxs("div",{className:"text-xs text-gray-500 font-semibold",children:["Creada el ",N(a.fechaCreacion)]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"flex flex-col gap-8 h-full",children:[e.jsx(v,{children:e.jsxs(A,{className:"p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-700 mb-4",children:"Información del producto"}),e.jsx("div",{className:"space-y-1",children:m.map((t,n)=>e.jsx(E,{label:t.label,value:t.value},n))})]})}),e.jsx("div",{className:"flex flex-col h-full",style:{minHeight:280},children:e.jsx(v,{className:"flex-1 h-full",children:e.jsxs(A,{className:"p-6 flex flex-col h-full",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-700 mb-4",children:"Valores de Proyección"}),e.jsx("div",{className:"space-y-1",children:D.map((t,n)=>e.jsx(E,{label:t.label,value:t.value},n))})]})})})]}),e.jsxs("div",{className:"flex flex-col gap-8 h-full",children:[e.jsx(v,{children:e.jsxs(A,{className:"p-6",children:[e.jsx("h2",{className:"text-md font-semibold text-gray-700 mb-3",children:"Rentabilidad y Capital de la Inversión (por período)"}),e.jsx("div",{className:"w-full min-h-[220px]",children:e.jsx(_,{width:"100%",height:220,children:e.jsxs(Q,{data:f,children:[e.jsx(Z,{strokeDasharray:"3 3"}),e.jsx(ee,{dataKey:"Periodo"}),e.jsx(ae,{}),e.jsx(te,{}),e.jsx(le,{}),e.jsx(k,{type:"monotone",dataKey:"Capital",stroke:"#6366f1",strokeWidth:2.5}),e.jsx(k,{type:"monotone",dataKey:"Rentabilidad",stroke:"#10b981",strokeWidth:2.5}),e.jsx(k,{type:"monotone",dataKey:"MontoPagar",stroke:"#f59e42",strokeWidth:2.5})]})})})]})}),e.jsx("div",{className:"flex flex-col h-full",style:{minHeight:280},children:e.jsx(v,{className:"flex-1 h-full",children:e.jsxs(A,{className:"p-6 flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(F,{className:"text-green-700"}),e.jsx("h2",{className:"font-semibold text-base",children:"Adendums de la Inversión"}),e.jsx(P,{className:"ml-auto bg-violet-600 hover:bg-violet-700 text-white px-4 py-2",size:"sm",onClick:()=>j(!0),disabled:y,children:"Nuevo Adendum"})]}),e.jsx(R,{columns:r,data:w,mostrarEditar:!y,mostrarEliminar:!1,mostrarAgregarNuevo:!1})]})})})]})]}),e.jsx(v,{children:e.jsxs(A,{className:"p-6",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2",children:[e.jsx(F,{})," Cronograma de la Inversión"]}),e.jsx(R,{columns:[{key:"Periodo",label:"Período"},{key:"FechaInicial",label:"Inicio",render:t=>N(t)},{key:"FechaVencimiento",label:"Vencimiento",render:t=>N(t)},{key:"Tasa",label:"Tasa",render:t=>t?`${Number(t).toFixed(2)}%`:"-"},{key:"AporteAdicional",label:"Aporte Adic.",render:s},{key:"CapitalOperacion",label:"Capital",render:s},{key:"Rentabilidad",label:"Rentabilidad",render:s},{key:"CapitalRenta",label:"Capital+Renta",render:s},{key:"CostoOperativo",label:"Coste Op.",render:s},{key:"RentaAcumulada",label:"Renta Acum.",render:s},{key:"CapitalFinal",label:"Capital Final",render:s},{key:"MontoPagar",label:"Monto Pagar",render:s}],data:u,mostrarEditar:!1,mostrarEliminar:!1,mostrarAgregarNuevo:!1})]})}),e.jsx(X,{open:g,onOpenChange:j,children:e.jsx(Y,{className:"bg-white rounded-xl max-w-lg w-full border",children:e.jsx(re,{inversion:a,cronograma:u,onClose:()=>j(!1),onSaved:()=>{j(!1),I()}})})})]}):e.jsx("div",{className:"text-center text-gray-600",children:"No se encontró la inversión."})}function E({label:l,value:o}){return e.jsxs("div",{className:"flex justify-between border-b last:border-b-0 pb-1 mb-1 last:mb-0 last:pb-0",children:[e.jsx("span",{className:"text-xs text-gray-600",children:l}),e.jsx("span",{className:"text-sm font-semibold text-gray-900 text-right",children:o??"-"})]})}export{be as default};
