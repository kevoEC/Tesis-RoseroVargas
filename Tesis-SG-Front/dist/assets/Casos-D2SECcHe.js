import{f as ue,u as me,c as ge,r as l,j as e,G as xe,h as W,I as p,L as q,B as N,t as c,E as pe,g as he}from"./index-ABbIRX4x.js";import{T as fe}from"./TablaCustom2-DS7_i3Ng.js";import{S as be}from"./switch-BQg2MTGH.js";import{a as ve,b as je,u as Q,e as ye}from"./CasosService-C8bij2xq.js";import{g as Ce}from"./InversionService-CD1AeE6A.js";import{g as Ne,a as we}from"./BancoService-CbhJQYfY.js";import{A as Ee}from"./AdjuntoForm-DZV0TiXW.js";import{D as De,a as Pe,b as Se,c as Te,d as Ie}from"./jspdf.plugin.autotable-CZR7NrjE.js";import"./index-CFqNEq9z.js";function Me(u){return u===18||u===19?[{key:"TipoPago",default:""},{key:"FechaPago",default:""},{key:"MontoPago",default:""},{key:"BancoPago",default:""},{key:"TipoCuentaPago",default:""},{key:"NumeroCuentaPago",default:""}]:u===13?[{key:"fechaCorte",default:""},{key:"correoEnvio",default:""}]:u===35?[{key:"MotivoTerminacion",default:""}]:[]}const Oe=[{value:1,label:"Rentabilidad mensual"},{value:2,label:"Pago final"},{value:3,label:"Terminación"}],Ae=[{value:1,label:"1"},{value:10,label:"10"},{value:20,label:"20"}],qe=[{id:6,nombre:"Autorización de actualización de datos"},{id:13,nombre:"Envío de estado de cuenta"},{id:18,nombre:"Pago"},{id:19,nombre:"Generación de pago manual"},{id:35,nombre:"Terminación de inversión"}],K=[18,19,35];function Fe({value:u,onChange:v,label:j,required:h=!0,disabled:w}){return e.jsx(d,{label:j,children:e.jsxs("div",{className:"relative",children:[e.jsx(p,{type:"date",value:u,onChange:v,className:`pr-10 ${w?"bg-gray-100 text-gray-500 cursor-not-allowed":""}`,required:h,disabled:w}),e.jsx(he,{className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none w-5 h-5"})]})})}function Ue(){const{id:u}=ue(),v=me(),{user:j}=ge(),h=j==null?void 0:j.id,[w,F]=l.useState(!0),[X,k]=l.useState(!0),[t,Y]=l.useState(null),[$,B]=l.useState([]),[S,Z]=l.useState([]),[T,ee]=l.useState([]),[i,I]=l.useState({}),[r,L]=l.useState(!1),[f,E]=l.useState(!1),[ae,M]=l.useState(!1),[y,z]=l.useState([]),[se,D]=l.useState(!1),[oe,G]=l.useState(null),[te,V]=l.useState(!1),O=async()=>{F(!0);try{const a=await ve(u);let s={};try{s=a.datosEspecificos?typeof a.datosEspecificos=="string"?JSON.parse(a.datosEspecificos):a.datosEspecificos:{}}catch{s={}}const o=Me(a.idMotivo);let m={};o.forEach(({key:n,default:de})=>{s[n]!==void 0&&s[n]!==null?m[n]=s[n]:a[n.charAt(0).toLowerCase()+n.slice(1)]!==void 0&&a[n.charAt(0).toLowerCase()+n.slice(1)]!==null?m[n]=a[n.charAt(0).toLowerCase()+n.slice(1)]:m[n]=de}),Y(a),I({...a,datosEspecificos:m}),L(!!a.continuarCaso);const[x,ce]=await Promise.all([Ne().catch(()=>[]),we().catch(()=>[])]);if(Z(x),ee(ce),a.idInversion&&K.includes(a.idMotivo))try{const n=await Ce();B(Array.isArray(n)?n:[])}catch{B([])}a.idCaso&&R(a.idCaso)}catch(a){c.error("Error al recargar el caso: "+(a.message??a))}finally{F(!1)}},R=async a=>{k(!0);try{const s=await je(a);z(s)}catch(s){c.error("Error al cargar documentos: "+s.message),z([])}finally{k(!1)}};l.useEffect(()=>{O()},[u]);const b=t&&qe.find(a=>a.id===t.idMotivo);let P="";if(t&&t.idInversion&&$.length>0){const a=$.find(s=>s.idInversion===t.idInversion);P=a?`${a.inversionNombre} - ${a.nombreCompletoCliente??""}`:`ID: ${t.idInversion}`}const g=(a,s)=>{I(o=>({...o,datosEspecificos:{...o.datosEspecificos,[a]:s}}))},_=()=>{var s;if(!t)return!1;const a=t.idMotivo;return a===18||a===19?["TipoPago","FechaPago","MontoPago","BancoPago","TipoCuentaPago","NumeroCuentaPago"].every(m=>{var x;return((x=i.datosEspecificos)==null?void 0:x[m])&&i.datosEspecificos[m].toString().trim()!==""}):a===13?["fechaCorte","correoEnvio"].every(m=>{var x;return((x=i.datosEspecificos)==null?void 0:x[m])&&i.datosEspecificos[m].toString().trim()!==""}):a===35?!!((s=i.datosEspecificos)!=null&&s.MotivoTerminacion)&&i.datosEspecificos.MotivoTerminacion.trim()!=="":!0},U=()=>y!=null&&y.length?y.filter(a=>!a.archivo).map(a=>a.tipoDocumentoNombre):[],A=U().length>0,re=()=>{if(!t)return null;const a=t.idMotivo,s=r;return a===19||a===18?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{label:"Tipo de Pago",children:e.jsxs("select",{className:`w-full border rounded-md p-2 bg-white text-sm ${s?"bg-gray-100 text-gray-500 cursor-not-allowed":""}`,value:i.datosEspecificos.TipoPago??"",onChange:o=>g("TipoPago",Number(o.target.value)),required:!0,disabled:s,children:[e.jsx("option",{value:"",hidden:!0,children:"Seleccionar tipo de pago..."}),Oe.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))]})}),e.jsx(Fe,{label:"Fecha de Pago",value:i.datosEspecificos.FechaPago??"",onChange:o=>g("FechaPago",o.target.value),disabled:s}),e.jsx(d,{label:"Monto de Pago",children:e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-2 top-2 text-gray-400 text-lg",children:"$"}),e.jsx(p,{type:"number",min:"0",step:"0.01",placeholder:"0.00",className:`pl-7 ${s?"bg-gray-100 text-gray-500 cursor-not-allowed":""}`,value:i.datosEspecificos.MontoPago??"",onChange:o=>g("MontoPago",o.target.value),required:!0,disabled:s})]})}),e.jsx(d,{label:"Banco",children:e.jsxs("select",{className:`w-full border rounded-md p-2 bg-white text-sm ${s?"bg-gray-100 text-gray-500 cursor-not-allowed":""}`,value:i.datosEspecificos.BancoPago??"",onChange:o=>g("BancoPago",Number(o.target.value)),required:!0,disabled:s,children:[e.jsx("option",{value:"",hidden:!0,children:"Seleccionar banco..."}),S==null?void 0:S.map(o=>e.jsx("option",{value:o.idBanco,children:o.bancoNombre},o.idBanco))]})}),e.jsx(d,{label:"Tipo de Cuenta",children:e.jsxs("select",{className:`w-full border rounded-md p-2 bg-white text-sm ${s?"bg-gray-100 text-gray-500 cursor-not-allowed":""}`,value:i.datosEspecificos.TipoCuentaPago??"",onChange:o=>g("TipoCuentaPago",Number(o.target.value)),required:!0,disabled:s,children:[e.jsx("option",{value:"",hidden:!0,children:"Seleccionar tipo de cuenta..."}),T==null?void 0:T.map(o=>e.jsx("option",{value:o.idTipoCuenta,children:o.nombre||o.descripcion||"Tipo de cuenta"},o.idTipoCuenta))]})}),e.jsx(d,{label:"Número de Cuenta",children:e.jsx(p,{type:"text",placeholder:"Ej: 123456789",className:s?"bg-gray-100 text-gray-500 cursor-not-allowed":"",value:i.datosEspecificos.NumeroCuentaPago??"",onChange:o=>g("NumeroCuentaPago",o.target.value),required:!0,disabled:s})})]}):a===13?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(d,{label:"Fecha de Corte",children:e.jsxs("select",{className:`w-full border rounded-md p-2 bg-white text-sm ${r?"bg-gray-100 text-gray-500 cursor-not-allowed":""}`,value:i.datosEspecificos.fechaCorte??"",onChange:o=>g("fechaCorte",Number(o.target.value)),required:!0,disabled:r,children:[e.jsx("option",{value:"",hidden:!0,children:"Seleccionar fecha de corte..."}),Ae.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))]})}),e.jsx(d,{label:"Correo de Envío",children:e.jsx(p,{type:"email",placeholder:"correo@ejemplo.com",className:r?"bg-gray-100 text-gray-500 cursor-not-allowed":"",value:i.datosEspecificos.correoEnvio??"",onChange:o=>g("correoEnvio",o.target.value),required:!0,disabled:r})})]}):a===35?e.jsx(d,{label:"Motivo de Terminación",children:e.jsx(p,{type:"text",placeholder:"Describe el motivo de terminación",className:r?"bg-gray-100 text-gray-500 cursor-not-allowed":"",value:i.datosEspecificos.MotivoTerminacion??"",onChange:o=>g("MotivoTerminacion",o.target.value),required:!0,disabled:r})}):null},ie=async a=>{if(a.preventDefault(),r&&!_()){c.warning("Debes completar todos los campos requeridos antes de continuar el flujo.");return}if(r&&A){c.warning("Debes cargar todos los documentos requeridos antes de continuar el flujo.");return}E(!0);try{const s={descripcion:i.descripcion,continuarCaso:r,estado:r?"Cerrado":i.estado,idUsuarioModificacion:h,idUsuarioPropietario:h,datosEspecificos:JSON.stringify(i.datosEspecificos)};await Q(t.idCaso,s),c.success("Caso actualizado correctamente"),O()}catch(s){c.error(`Error al actualizar caso: ${s.message??s}`)}finally{E(!1)}},ne=()=>{if(!r){if(!_()){c.warning("Debes completar todos los campos requeridos antes de continuar el flujo.");return}if(A){c.warning("Debes cargar todos los documentos requeridos antes de continuar el flujo.");return}M(!0)}},le=async()=>{M(!1),E(!0);try{const a={descripcion:i.descripcion,continuarCaso:!0,estado:"Cerrado",idUsuarioModificacion:h,idUsuarioPropietario:h,datosEspecificos:JSON.stringify(i.datosEspecificos)};await Q(t.idCaso,a),c.success("Caso actualizado correctamente");const s=await ye(t.idCaso);s.success?c.success("Flujo continuado correctamente"):c.error("Error al continuar flujo: "+(s.message||"Error desconocido")),L(!0),await O()}catch(a){c.error(`Error al continuar flujo: ${a.message??a}`)}finally{E(!1)}},J=a=>{switch(a){case"Iniciado":return"bg-blue-100 text-blue-700";case"Cerrado":return"bg-gray-300 text-gray-700";default:return"bg-yellow-100 text-yellow-700"}},C=r||t&&t.estado==="Cerrado",H=[{key:"idDocumento",label:"ID"},{key:"tipoDocumentoNombre",label:"Tipo de Documento"},{key:"motivoNombre",label:"Motivo"},{key:"documentoNombre",label:"Nombre"}];return C&&H.push({key:"ver",label:"Ver",render:(a,s)=>e.jsx(N,{type:"button",size:"icon",variant:"ghost",className:"text-primary hover:bg-violet-100",onClick:()=>{G(s.idDocumento),V(!0),D(!0)},title:"Ver",children:e.jsx(pe,{size:18})})}),w||X||!t?e.jsx(xe,{visible:!0,message:"Cargando caso..."}):e.jsxs("div",{className:"relative",children:[C&&e.jsxs("div",{className:"w-full flex items-center px-6 py-2 bg-gray-50 border-b border-gray-300 shadow-sm mb-2 z-50",style:{position:"sticky",top:0},children:[e.jsx(W,{className:"text-gray-700 w-5 h-5 mr-2"}),e.jsxs("span",{className:"font-semibold text-gray-700 text-sm",children:["Solo lectura: estado de este registro: ",e.jsx("span",{className:"text-violet-700",children:t.estado==="Cerrado"||r?"Cerrado":t.estado})]})]}),e.jsxs("div",{className:"p-6 md:p-10 max-w-6xl mx-auto bg-white",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-2",children:[e.jsxs("h1",{className:"text-2xl md:text-3xl font-bold text-gray-900",children:[t.numeroCaso," - ",(b==null?void 0:b.nombre)||t.motivoNombre]}),e.jsx("span",{className:`ml-3 px-3 py-1 text-xs font-semibold rounded-full ${J(r?"Cerrado":t.estado)}`,children:r?"Cerrado":t.estado})]}),e.jsxs("div",{className:"flex flex-wrap text-xs text-gray-700 mb-6 border-b pb-2 gap-8",children:[e.jsxs("span",{children:[e.jsx("b",{children:"Cliente:"})," ",t.nombreCliente]}),t.idInversion&&P&&e.jsxs("span",{children:[e.jsx("b",{children:"Inversión:"})," ",P]}),e.jsxs("span",{children:[e.jsx("b",{children:"Creado:"})," ",t.fechaCreacion?new Date(t.fechaCreacion).toLocaleString("es-EC"):"-"]}),e.jsxs("span",{children:[e.jsx("b",{children:"Owner:"})," ",t.nombreUsuarioPropietario||"-"]})]}),e.jsxs("form",{onSubmit:ie,className:"grid grid-cols-1 md:grid-cols-2 gap-6 items-start",children:[e.jsxs("section",{className:"border rounded-xl p-6 shadow-sm mb-0 flex flex-col gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-3",children:"General"}),t.idInversion&&K.includes(t.idMotivo)?e.jsx(d,{label:"Producto de inversión",children:e.jsx(p,{value:P,disabled:!0,className:"bg-gray-100 text-gray-500 font-medium",style:{fontWeight:500}})}):null,e.jsx(d,{label:"Motivo",children:e.jsx(p,{value:(b==null?void 0:b.nombre)||t.motivoNombre,disabled:!0,className:"bg-gray-100 text-gray-500 font-medium",style:{fontWeight:500}})}),e.jsx(d,{label:"Descripción",children:e.jsx("textarea",{className:`w-full border border-gray-300 rounded-lg p-2 text-sm ${r?"bg-gray-100 text-gray-500 cursor-not-allowed":""}`,value:i.descripcion||"",onChange:a=>I(s=>({...s,descripcion:a.target.value})),rows:3,required:!0,disabled:r})}),re()]}),e.jsxs("div",{className:"flex flex-col gap-6 w-full",children:[e.jsxs("section",{className:"border rounded-xl p-6 shadow-sm flex flex-col gap-6",children:[A&&e.jsxs("div",{className:"bg-yellow-100 border border-yellow-300 text-yellow-800 p-3 rounded mb-4 flex flex-col gap-2",children:[e.jsx("b",{children:"Faltan documentos por cargar:"}),e.jsx("ul",{className:"list-disc pl-6",children:U().map((a,s)=>e.jsx("li",{children:a},s))})]}),e.jsxs("div",{children:[e.jsx(q,{className:"font-medium text-gray-700 text-sm mb-1 block",children:"Estado actual"}),e.jsx("span",{className:`inline-block px-3 py-1 text-xs font-semibold rounded-full ${J(r?"Cerrado":t.estado)}`,children:r?"Cerrado":t.estado})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(q,{className:"font-medium text-gray-700 text-base",children:"¿Continuar flujo?"}),e.jsx(be,{checked:r,onCheckedChange:ne,disabled:r||f,className:"data-[state=checked]:bg-violet-600 border data-[state=checked]:border-violet-600 data-[state=unchecked]:border-gray-300 data-[state=unchecked]:bg-gray-200 h-6 w-11 rounded-full relative transition-colors duration-200"})]}),e.jsxs("div",{className:"flex gap-4 mt-2",children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>v("/casos/vista"),className:"px-6",disabled:f,children:"Regresar"}),e.jsxs(N,{type:"submit",className:"bg-violet-600 hover:bg-violet-700 text-white px-8",disabled:r||f,children:[f?e.jsx("span",{className:"animate-spin mr-2",children:"⏳"}):null,"Actualizar Caso"]})]})]}),e.jsxs("section",{className:"border border-gray-300 rounded-xl p-6 shadow-sm mt-0",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-3",children:"Documentos Adjuntos"}),e.jsx(fe,{columns:H,data:y,mostrarEditar:!C,mostrarAgregarNuevo:!1,mostrarEliminar:!1,onEditarClick:a=>{G(a.idDocumento),V(C),D(!0)}})]})]})]}),e.jsx(De,{open:se,onOpenChange:D,children:e.jsxs(Pe,{children:[e.jsxs(Se,{children:[e.jsx(Te,{children:"Adjunto"}),e.jsx(Ie,{children:C?"Visualización de archivo adjunto":"Editar archivo"})]}),e.jsx(Ee,{documentoId:oe,readOnly:te,onClose:()=>{D(!1),t!=null&&t.idCaso&&R(t.idCaso)}})]})}),ae&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex justify-center items-center z-50",children:e.jsxs("div",{className:"bg-white p-7 rounded-xl shadow-lg max-w-sm w-full border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(W,{className:"w-6 h-6 text-yellow-500"}),e.jsx("span",{className:"font-bold text-lg text-gray-800",children:"¿Estás seguro?"})]}),e.jsxs("p",{className:"text-gray-700 mb-4",children:["Si continúas con el flujo, este caso se bloqueará y no podrá ser editado.",e.jsx("br",{}),e.jsx("b",{children:"¿Deseas continuar?"})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-5",children:[e.jsx(N,{variant:"outline",onClick:()=>M(!1),children:"Cancelar"}),e.jsxs(N,{className:"bg-violet-600 text-white",onClick:le,disabled:f,children:[f?e.jsx("span",{className:"animate-spin mr-2",children:"⏳"}):null,"Sí, continuar flujo"]})]})]})})]})]})}function d({label:u,children:v}){return e.jsxs("div",{className:"space-y-1.5 relative",children:[e.jsx(q,{className:"font-medium text-gray-700 text-sm",children:u}),v]})}export{Ue as default};
