import{c as N,r as t,j as e,G as w,B as j,t as d,L as D,u as I,C as M,d as E,e as k,a as S}from"./index-ABbIRX4x.js";import{T as O}from"./TablaCustom2-DS7_i3Ng.js";import{D as T,a as A,b as L,c as z,d as F}from"./jspdf.plugin.autotable-CZR7NrjE.js";import{c as G,d as _,f as q}from"./CasosService-C8bij2xq.js";import{c as B}from"./ClienteService-Crd2CGs_.js";import{g as P}from"./InversionService-CD1AeE6A.js";const V=[{idMotivo:6,nombre:"Autorización de actualización de datos"},{idMotivo:19,nombre:"Generación de pago manual"},{idMotivo:35,nombre:"Terminación de inversión"}],y=[19,35];function W({onClose:i,onSaved:l,initialData:x}){const{user:n}=N(),[p,h]=t.useState(!1),[m,u]=t.useState([]),[C,v]=t.useState([]),[r,g]=t.useState({idCliente:"",idMotivo:"",descripcion:"",idInversion:"",continuarCaso:!1,estado:"Iniciado",...x});t.useEffect(()=>{(async()=>{try{const o=await B();u(o);const f=await P();v(f)}catch(o){d.error("Error al cargar clientes o inversiones: "+o.message)}})()},[]),t.useEffect(()=>{y.includes(Number(r.idMotivo))||g(a=>({...a,idInversion:""}))},[r.idMotivo]);const c=(a,o)=>g(f=>({...f,[a]:o})),s=async a=>{a.preventDefault(),h(!0);try{const o={idCliente:Number(r.idCliente),idMotivo:Number(r.idMotivo),descripcion:r.descripcion,idInversion:r.idInversion?Number(r.idInversion):null,continuarCaso:r.continuarCaso||!1,estado:r.estado||"Iniciado",idUsuarioCreacion:n==null?void 0:n.id,idUsuarioPropietario:n==null?void 0:n.id,idPago:null};await G(o),d.success("Caso creado correctamente"),l==null||l(),i==null||i()}catch(o){d.error(`Error al crear caso: ${o.message??o}`)}finally{h(!1)}};return e.jsxs("div",{className:"relative px-2 py-3 md:px-7 md:py-7",children:[e.jsx(w,{visible:p,message:"Guardando caso..."}),e.jsxs("form",{onSubmit:s,className:"space-y-8 max-w-xl mx-auto",autoComplete:"off",children:[e.jsxs("section",{className:"bg-white rounded-2xl border border-gray-300 px-7 py-5 flex flex-col gap-4 shadow-lg transition-colors",children:[e.jsx("h3",{className:"font-semibold text-lg text-blue-900 mb-3 border-b pb-2",children:"Datos del Caso"}),e.jsx(b,{label:"Cliente",children:e.jsxs("select",{className:"w-full border rounded-md p-2 bg-white text-sm",value:r.idCliente,onChange:a=>c("idCliente",a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar cliente..."}),m.map(a=>e.jsxs("option",{value:a.idCliente,children:[a.numeroDocumento," — ",a.nombres," ",a.apellidoPaterno," ",a.apellidoMaterno]},a.idCliente))]})}),e.jsx(b,{label:"Motivo del Caso",children:e.jsxs("select",{className:"w-full border rounded-md p-2 bg-white text-sm",value:r.idMotivo,onChange:a=>c("idMotivo",a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar motivo..."}),V.map(a=>e.jsx("option",{value:a.idMotivo,children:a.nombre},a.idMotivo))]})}),e.jsx(b,{label:"Descripción",children:e.jsx("textarea",{className:"w-full border rounded-md p-2 bg-white text-sm",placeholder:"Descripción breve del caso",value:r.descripcion,rows:4,onChange:a=>c("descripcion",a.target.value),required:!0})}),y.includes(Number(r.idMotivo))&&e.jsx(b,{label:"Inversión asociada",children:e.jsxs("select",{className:"w-full border rounded-md p-2 bg-white text-sm",value:r.idInversion,onChange:a=>c("idInversion",a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar inversión..."}),C.map(a=>e.jsxs("option",{value:a.idInversion,children:[a.inversionNombre," | ",a.nombreCompletoCliente]},a.idInversion))]})})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[e.jsx(j,{type:"button",variant:"outline",onClick:i,className:"px-6 py-2",children:"Cancelar"}),e.jsx(j,{type:"submit",className:"bg-violet-600 hover:bg-violet-700 text-white px-6 py-2",children:x?"Actualizar Caso":"Crear Caso"})]})]})]})}function b({label:i,children:l}){return e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(D,{className:"font-medium text-gray-700 text-sm",children:i}),l]})}function Q(){const i=I(),[l,x]=t.useState([]),[n,p]=t.useState(!0),[h,m]=t.useState(!1),u=async()=>{p(!0);try{const s=await _();x(s)}catch(s){d.error("Error al cargar casos: "+(s.message??s))}finally{p(!1)}};t.useEffect(()=>{u()},[]);const C=()=>m(!0),v=s=>{i(`/casos/editar/${s.idCaso}`)},r=async s=>{if(window.confirm("¿Eliminar este caso?"))try{await q(s.idCaso),d.success("Caso eliminado."),u()}catch(a){d.error("Error al eliminar caso: "+(a.message??a))}},g=[{key:"idCaso",label:"",render:s=>e.jsxs("div",{className:"flex items-center justify-center group relative text-violet-500",children:[e.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",strokeWidth:"1.8",viewBox:"0 0 24 24",children:[e.jsx("rect",{x:"4",y:"4",width:"16",height:"16",rx:"2",stroke:"currentColor",strokeWidth:"1.8"}),e.jsx("path",{d:"M8 8h8M8 12h8M8 16h4",stroke:"currentColor",strokeWidth:"1.5"})]}),e.jsxs("span",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-1 text-xs text-white bg-zinc-800 px-2 py-0.5 rounded shadow opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-50 whitespace-nowrap",children:["ID: ",s]})]})},{key:"numeroCaso",label:"Número"},{key:"nombreCliente",label:"Cliente"},{key:"motivoNombre",label:"Motivo"},{key:"descripcion",label:"Descripción"},{key:"estado",label:"Estado",render:s=>e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full ${s==="Iniciado"?"bg-blue-100 text-blue-700":s==="Cerrado"?"bg-gray-300 text-gray-700":"bg-yellow-100 text-yellow-700"}`,children:s})},{key:"fechaCreacion",label:"Fecha Creación",render:s=>s?new Date(s).toLocaleDateString():""}],c=[...l].sort((s,a)=>new Date(a.fechaCreacion)-new Date(s.fechaCreacion));return e.jsxs("div",{className:"p-4 sm:p-6 md:p-8 max-w-full relative",children:[e.jsx(w,{visible:n,message:"Cargando casos..."}),e.jsxs(M,{className:"w-full border border-muted rounded-xl shadow-[0_4px_10px_rgba(0,0,0,0.12)]",children:[e.jsx(E,{children:e.jsx(k,{className:"text-3xl flex items-center",children:"Lista de Casos"})}),e.jsx(S,{className:"p-6 overflow-x-auto",children:e.jsx(O,{columns:g,data:c,mostrarEditar:!0,mostrarAgregarNuevo:!0,mostrarEliminar:!0,onAgregarNuevoClick:C,onEditarClick:v,onEliminarClick:r})})]}),e.jsx(T,{open:h,onOpenChange:m,children:e.jsxs(A,{className:"min-w-[420px] max-w-xl",children:[e.jsxs(L,{children:[e.jsx(z,{children:"Agregar Caso"}),e.jsx(F,{children:"Completa la información del nuevo caso"})]}),e.jsx(W,{onClose:()=>m(!1),onSaved:u})]})})]})}export{Q as default};
