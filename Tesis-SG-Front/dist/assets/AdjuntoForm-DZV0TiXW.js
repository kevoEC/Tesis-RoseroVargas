import{A as m,r as i,j as e,z as O,E as W,a6 as X,B as b,a7 as P,a8 as _,L as z,I,S as G,t as j}from"./index-ABbIRX4x.js";const x=async a=>{if(!a.ok){const t=await a.text();throw new Error(t||"Error en la solicitud")}return await a.json()},f=()=>{var t;return{"Content-Type":"application/json",Authorization:`Bearer ${(t=JSON.parse(localStorage.getItem("user")))==null?void 0:t.token}`}},V=async a=>{const t=await fetch(`${m}/vista/documento/filtrar?por=IdDocumento&id=${a}`,{headers:f()});return x(t)},q=async(a,t)=>{const r=await fetch(`${m}/Documento/${a}/archivo`,{method:"PUT",headers:f(),body:JSON.stringify(t)});return x(r)},Q=async a=>{const t=await fetch(`${m}/Documento/motivo`,{method:"POST",headers:f(),body:JSON.stringify(a)});return x(t)},Y=async(a,t)=>{const r=await fetch(`${m}/Documento/motivo/32?idSolicitudInversion=${a}`,{method:"DELETE",headers:f()});return x(r)},Z=async(a,t=32)=>{const r=await fetch(`${m}/documento/por-solicitud-y-motivo?idSolicitudInversion=${a}&idMotivo=${t}`,{headers:f()});return x(r)},H=async a=>{var g;const t=(g=JSON.parse(localStorage.getItem("user")))==null?void 0:g.token,r=await fetch(`${m}/documento/descargar/${a}`,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)throw new Error("No se pudo descargar el archivo");return await r.blob()};function ee({documentoId:a,onClose:t,readOnly:r=!1}){const[g,y]=i.useState(""),[w,N]=i.useState(""),[S,D]=i.useState(null),[R,k]=i.useState(""),[B,C]=i.useState("Subido por el cliente"),[d,v]=i.useState(!1),[F,l]=i.useState(""),[u,U]=i.useState(null),h=i.useRef(),A=async()=>{var n,s,o,p;v(!0),l("");try{const c=await V(a);U(c[0]);const E=((n=c[0])==null?void 0:n.base64Contenido)||((s=c[0])==null?void 0:s.archivo)||"",$=E.startsWith("data:")?E.split(",")[1]:E;k(((o=c[0])==null?void 0:o.documentoNombre)||""),$?(y($),N(L($))):(y(""),N("")),C(((p=c[0])==null?void 0:p.observaciones)||"Subido por el cliente")}catch(c){l("Error al cargar el archivo."+(c.message||""))}finally{v(!1)}};i.useEffect(()=>{A()},[a]);const L=n=>{const s=n.slice(0,10);return s.startsWith("JVBERi0")?"pdf":s.startsWith("UEsD")?"docx":""},J=n=>{const s=n.target.files[0];if(!s)return;if(s.type!=="application/pdf"&&s.type!=="application/vnd.openxmlformats-officedocument.wordprocessingml.document"){l("Solo se permite PDF o DOCX."),h.current.value="";return}if(s.size>1024*1024){l("El archivo debe ser de máximo 1MB."),h.current.value="";return}l(""),k(s.name);const o=new FileReader;o.onload=()=>{const c=o.result.split(",")[1];D(c),y(c),N(L(c))},o.readAsDataURL(s)},M=async()=>{if(!S){l("Selecciona un archivo para continuar");return}v(!0),l("");try{(await q(a,{base64Contenido:S,observaciones:B})).success?(j.success("Archivo guardado correctamente"),await A(),D(null),h.current&&(h.current.value=""),t==null||t()):j.error("Error al guardar el archivo")}catch{j.error("Ocurrió un error al guardar")}finally{v(!1)}},T=async()=>{try{const n=await H(a),s=window.URL.createObjectURL(n),o=document.createElement("a");o.href=s;const p=R||`documento_${a}.${w||"docx"}`;o.download=p,document.body.appendChild(o),o.click(),o.remove()}catch{j.error("No se pudo descargar el archivo")}};return e.jsxs("div",{className:"space-y-6 p-2 md:p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(O,{className:"text-primary w-5 h-5"}),e.jsx("h2",{className:"text-xl md:text-2xl font-semibold",children:"Adjunto"}),r&&e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-gray-100 border text-xs rounded text-gray-700 flex items-center gap-1",children:[e.jsx(W,{className:"w-4 h-4 inline"})," Solo lectura"]})]}),F&&e.jsxs("div",{className:"bg-red-100 border border-red-200 text-red-700 px-3 py-2 rounded text-sm flex items-center gap-2",children:[e.jsx(X,{className:"w-4 h-4"})," ",F]}),e.jsx("div",{className:"rounded border bg-gray-50 p-2 md:p-4 flex flex-col items-center w-full",children:w==="pdf"?e.jsx("iframe",{src:`data:application/pdf;base64,${g}`,title:"Vista previa del documento",className:"w-full min-h-[400px] max-h-[600px] border border-gray-200 rounded-md shadow"}):w==="docx"?e.jsxs("div",{className:"flex flex-col items-center gap-3 w-full",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-8 h-8 text-blue-600"}),e.jsx("span",{className:"text-base font-medium",children:R||"Archivo Word"})]}),e.jsxs(b,{type:"button",variant:"outline",className:"flex items-center gap-2",onClick:T,disabled:d,children:[e.jsx(P,{className:"w-4 h-4"}),"Descargar archivo"]})]}):e.jsxs("div",{className:"flex flex-col items-center gap-3 w-full py-6",children:[e.jsx("p",{className:"text-gray-500 text-sm text-center",children:u?u.archivo||u.base64Contenido?"El documento no puede ser previsualizado aquí, pero puedes intentar descargarlo.":"Aún no se ha generado o cargado ningún archivo para este documento.<br/>Si acabas de generarlo, intenta recargar.":"No hay archivo cargado."}),e.jsxs(b,{variant:"ghost",className:"flex items-center gap-2 text-gray-500",onClick:A,disabled:d,title:"Recargar adjunto",children:[e.jsx(_,{className:"w-4 h-4"})," Recargar"]}),(u==null?void 0:u.archivo)&&e.jsxs(b,{type:"button",variant:"outline",className:"flex items-center gap-2",onClick:T,disabled:d,children:[e.jsx(P,{className:"w-4 h-4"}),"Descargar archivo"]})]})}),!r&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs(z,{className:"text-sm font-medium text-gray-700",children:["Seleccionar archivo ",e.jsx("span",{className:"text-xs text-gray-500",children:"(PDF o DOCX, máx. 1MB)"})]}),e.jsx(I,{ref:h,type:"file",accept:"application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document",onChange:J,className:"cursor-pointer file:text-sm file:font-medium file:bg-primary file:text-white file:border-0 file:px-4 file:py-2 file:rounded-md",disabled:d||r})]}),e.jsxs("div",{children:[e.jsx(z,{className:"text-sm font-medium text-gray-700",children:"Observaciones"}),e.jsx(I,{value:B,onChange:n=>C(n.target.value),placeholder:"Subido por el cliente",disabled:r})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(b,{type:"button",onClick:M,disabled:d||!S||r,className:"bg-primary text-white hover:bg-primary/80 flex items-center gap-2",children:[e.jsx(G,{className:"w-4 h-4"}),d?"Guardando...":"Guardar Adjunto"]})})]})]})}export{ee as A,Q as a,Y as d,Z as g};
